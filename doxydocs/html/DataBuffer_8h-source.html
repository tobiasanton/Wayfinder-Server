<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mc2: DataBuffer.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">Shared</a>&nbsp;/&nbsp;<a class="el" href="dir_000001.html">include</a></div>
<h1>DataBuffer.h</h1><a href="DataBuffer_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 1999 - 2010, Vodafone Group Services Ltd</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
00008 <span class="comment">    * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
00009 <span class="comment">    * Neither the name of the Vodafone Group Services Ltd nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</span>
00010 <span class="comment"></span>
00011 <span class="comment">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00012 <span class="comment">*/</span>
00013 
00014 <span class="preprocessor">#ifndef NEWDATABUFFER_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#define NEWDATABUFFER_H</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#include "<a class="code" href="config_8h.html">config.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="AlignUtility_8h.html">AlignUtility.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="SharedBuffer_8h.html">SharedBuffer.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="sockets_8h.html">sockets.h</a>"</span>
00021 
<a name="l00029"></a><a class="code" href="classDataBuffer.html">00029</a> <span class="keyword">class </span><a class="code" href="classDataBuffer.html">DataBuffer</a> : <span class="keyword">public</span> <a class="code" href="classSharedBuffer.html">SharedBuffer</a> {
00030 <span class="keyword">public</span>:
00035       <a class="code" href="classDataBuffer.html#a0">DataBuffer</a>();
00036 
00043       <a class="code" href="classDataBuffer.html#a0">DataBuffer</a>(<a class="code" href="Types_8h.html#a21">uint32</a> bufSize, <span class="keywordtype">bool</span> quiet = <span class="keyword">false</span>);
00044            
00054       <a class="code" href="classDataBuffer.html#a0">DataBuffer</a>(<a class="code" href="Types_8h.html#a21">uint32</a> bufSize, <span class="keyword">const</span> <span class="keywordtype">char</span>* name, <span class="keywordtype">bool</span> quiet = <span class="keyword">false</span>);
00055       
00061       <a class="code" href="classDataBuffer.html#a0">DataBuffer</a>(<a class="code" href="Types_8h.html#a25">byte</a> *buffer, <a class="code" href="Types_8h.html#a21">uint32</a> bufSize);
00062 
00073       <a class="code" href="classDataBuffer.html#a0">DataBuffer</a>(<span class="keyword">const</span> <a class="code" href="classDataBuffer.html">DataBuffer</a>&amp; other, <span class="keywordtype">bool</span> shrinkToOffset = <span class="keyword">false</span> );
00074 
00082       <a class="code" href="classDataBuffer.html#a0">DataBuffer</a>(<span class="keyword">const</span> <a class="code" href="classSharedBuffer.html">SharedBuffer</a>&amp; other, <span class="keywordtype">bool</span> shrinkToOffset = <span class="keyword">false</span> );
00083 
00087       <span class="keyword">virtual</span> <a class="code" href="classDataBuffer.html#a6">~DataBuffer</a>();
00088   
00094       <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a21">uint32</a> <a class="code" href="classDataBuffer.html#a7">readNextLong</a>();
00100    <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a26">float32</a> <a class="code" href="classDataBuffer.html#a8">readNextFloat</a>();
00101 
00107       <span class="keyword">template</span>&lt;<span class="keyword">class</span> TYPE&gt; <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a7">readNextLong</a>(TYPE&amp; value);
00108 
00115       <span class="keyword">template</span>&lt;<span class="keyword">class</span> TYPE&gt; <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a11">readNextLongAligned</a>(TYPE&amp; value);
00116 
00121       <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a21">uint32</a> <a class="code" href="classDataBuffer.html#a11">readNextLongAligned</a>();
00122       
00128       <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a21">uint32</a> <a class="code" href="classDataBuffer.html#a12">readLong</a>(<a class="code" href="Types_8h.html#a21">uint32</a> index);
00129 
00134       <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a13">writeNextLong</a>(<a class="code" href="Types_8h.html#a21">uint32</a> data);
00135 
00140    <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a14">writeNextFloat</a>( <a class="code" href="Types_8h.html#a26">float32</a> data );
00141 
00147       <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a15">writeLong</a>(<a class="code" href="Types_8h.html#a21">uint32</a> data, <a class="code" href="Types_8h.html#a21">uint32</a> index);
00148    
00153       <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a19">uint16</a> <a class="code" href="classDataBuffer.html#a16">readNextShort</a>();
00154 
00160       <span class="keyword">template</span>&lt;<span class="keyword">class</span> TYPE&gt; <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a16">readNextShort</a>(TYPE&amp; value);
00161 
00167       <span class="keyword">template</span>&lt;<span class="keyword">class</span> TYPE&gt; <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a19">readNextShortAligned</a>(TYPE&amp; value);
00168 
00174       <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a19">uint16</a> <a class="code" href="classDataBuffer.html#a19">readNextShortAligned</a>();
00175 
00181       <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a19">uint16</a> <a class="code" href="classDataBuffer.html#a20">readShort</a>(<a class="code" href="Types_8h.html#a21">uint32</a> index);
00182    
00187       <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a21">writeNextShort</a>(<a class="code" href="Types_8h.html#a19">uint16</a> data);   
00188 
00194       <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a22">writeShort</a>(<a class="code" href="Types_8h.html#a19">uint16</a> data, <a class="code" href="Types_8h.html#a21">uint32</a> index);
00195    
00200       <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a25">byte</a> <a class="code" href="classDataBuffer.html#a23">readNextByte</a>();
00201 
00206       <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a24">writeNextByte</a>( <a class="code" href="Types_8h.html#a17">uint8</a> value );   
00207    
00213       <a class="code" href="Types_8h.html#a25">byte</a> <a class="code" href="classDataBuffer.html#a25">readByte</a>(<a class="code" href="Types_8h.html#a21">uint32</a> index);
00214 
00220       <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a26">writeByte</a>(<a class="code" href="Types_8h.html#a25">byte</a> data, <a class="code" href="Types_8h.html#a21">uint32</a> index);
00221 
00227       <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classDataBuffer.html#a27">readNextBool</a>();
00228 
00234       <span class="keywordtype">bool</span> <a class="code" href="classDataBuffer.html#a28">readBool</a>(<a class="code" href="Types_8h.html#a21">uint32</a> index);
00235 
00240       <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a29">writeNextBool</a>(<span class="keywordtype">bool</span> data);   
00241 
00247       <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a30">writeBool</a>(<span class="keywordtype">bool</span> data, <a class="code" href="Types_8h.html#a21">uint32</a> index);
00248 
00253       <a class="code" href="Types_8h.html#a21">uint32</a> <a class="code" href="classDataBuffer.html#a31">getNextStringSize</a>();
00254       
00259      <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a32">alignToLongAndClear</a>();
00260 
00264       <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a33">alignToLong</a>();
00265 
00269       <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a34">alignToShort</a>();
00270 
00277       <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a35">setName</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* name);
00278    
00284       <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a36">dump</a>(<span class="keywordtype">bool</span> wholeBuffer = <span class="keyword">false</span>);
00285 
00296       <span class="keywordtype">bool</span> <a class="code" href="classDataBuffer.html#a37">memMapFile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* file,
00297                       <span class="keywordtype">bool</span> readWrite = <span class="keyword">false</span>,
00298                       <span class="keywordtype">bool</span> exitIfFails = <span class="keyword">true</span> );
00299 
00306       <span class="keywordtype">bool</span> <a class="code" href="classDataBuffer.html#a38">equals</a>( <a class="code" href="classDataBuffer.html">DataBuffer</a>&amp; otherBuffer ) <span class="keyword">const</span>;
00307 
00313       <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a39">saveToStream</a>(ostream&amp; outStream);
00314 
00321       <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a40">restoreFromStream</a>(istream&amp; inStream, <a class="code" href="Types_8h.html#a21">uint32</a> maxBytes = 0);
00322 
00329       <span class="keyword">friend</span> ostream&amp; <a class="code" href="classDataBuffer.html#n0">operator&lt;&lt; </a>(ostream&amp; outStream, <a class="code" href="classDataBuffer.html">DataBuffer</a>&amp; dBuffer);
00330 
00337       <span class="keyword">friend</span> istream&amp; <a class="code" href="classDataBuffer.html#n1">operator&gt;&gt; </a>(istream&amp; inStream, <a class="code" href="classDataBuffer.html">DataBuffer</a>&amp; dBuffer);
00338 
00342    <span class="keywordtype">bool</span> <a class="code" href="classDataBuffer.html#a41">isMMaped</a>() <span class="keyword">const</span>;
00343 
00344 
00345 <span class="keyword">protected</span>:
<a name="l00349"></a><a class="code" href="classDataBuffer.html#p0">00349</a>       <span class="keywordtype">int</span> m_mmapFD;
00350 
<a name="l00354"></a><a class="code" href="classDataBuffer.html#p1">00354</a>       <span class="keyword">const</span> <span class="keywordtype">char</span>* m_name;
00355 
00363       <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#b0">outsideBufferErrorPrint</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* methodName) <span class="keyword">const</span>;
00364   
00365 <span class="keyword">private</span>:
00366 
00368       <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#d0">init</a>(uint32 size, <span class="keyword">const</span> <span class="keywordtype">char</span>* name, <span class="keywordtype">bool</span> quiet);
00369 
00371       <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#d1">initNotSelfAlloc</a>(byte* buf, uint32 size, uint32 curOffset,
00372                             <span class="keyword">const</span> <span class="keywordtype">char</span>* name);
00373 
00374 };
00375 
00376 
00377 <span class="comment">// ========================================================================</span>
00378 <span class="comment">//                                      Implementation of inlined methods =</span>
00379 
00380 <span class="keyword">inline</span> <span class="keywordtype">void</span> 
<a name="l00381"></a><a class="code" href="classDataBuffer.html#a32">00381</a> <a class="code" href="classDataBuffer.html#a32">DataBuffer::alignToLongAndClear</a>() 
00382 {
00383    <a class="code" href="Types_8h.html#a17">uint8</a>* newPos = m_pos;
00384    <a class="code" href="namespaceAlignUtility.html#a4">AlignUtility::alignLong</a>(newPos);
00385    <span class="keywordflow">while</span> (m_pos &lt; newPos) {
00386       <a class="code" href="MC2Logging_8h.html#a5">mc2dbg4</a> &lt;&lt; <a class="code" href="MC2Logging_8h.html#a7">here</a> &lt;&lt; <span class="stringliteral">" Clearing one byte..."</span> &lt;&lt; endl;
00387       <a class="code" href="classDataBuffer.html#a24">writeNextByte</a>(0);
00388    }
00389 }
00390 
00391 <span class="keyword">inline</span> <span class="keywordtype">void</span> 
<a name="l00392"></a><a class="code" href="classDataBuffer.html#a33">00392</a> <a class="code" href="classDataBuffer.html#a33">DataBuffer::alignToLong</a>() 
00393 {
00394    <a class="code" href="namespaceAlignUtility.html#a4">AlignUtility::alignLong</a>(m_pos);
00395 }
00396 
00397 <span class="keyword">inline</span> <span class="keywordtype">void</span> 
<a name="l00398"></a><a class="code" href="classDataBuffer.html#a34">00398</a> <a class="code" href="classDataBuffer.html#a34">DataBuffer::alignToShort</a>() 
00399 {
00400    <a class="code" href="namespaceAlignUtility.html#a0">AlignUtility::alignShort</a>(m_pos); 
00401 }
00402 
00403 <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00404"></a><a class="code" href="classDataBuffer.html#a35">00404</a> <a class="code" href="classDataBuffer.html#a35">DataBuffer::setName</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* name)
00405 {
00406    <a class="code" href="classDataBuffer.html#p1">m_name</a> = name;
00407 }
00408 
00409 <span class="comment">// New implementation</span>
00410 
00411 <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a21">uint32</a> 
<a name="l00412"></a><a class="code" href="classDataBuffer.html#a11">00412</a> <a class="code" href="classDataBuffer.html#a11">DataBuffer::readNextLongAligned</a>() 
00413 {
00414 <span class="preprocessor">#ifdef _DEBUG</span>
00415 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a37">almostAssert</a>((<a class="code" href="Types_8h.html#a21">uint32</a>(m_pos) &amp; 3) == 0);
00416 <span class="preprocessor">#endif</span>
00417 <span class="preprocessor"></span><span class="preprocessor">#if !defined(_MSC_VER) || defined(_DEBUG)</span>
00418 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ( m_pos &gt; (m_buf + m_bufSize)) {
00419       <a class="code" href="classDataBuffer.html#b0">outsideBufferErrorPrint</a>(<span class="stringliteral">"readNextLongAligned"</span>);
00420    }
00421 <span class="preprocessor">#endif</span>
00422 <span class="preprocessor"></span>
00423 <span class="preprocessor">#ifdef _WIN32</span>
00424 <span class="preprocessor"></span>   <a class="code" href="Types_8h.html#a21">uint32</a> tempLong = *(reinterpret_cast&lt;uint32*&gt;(m_pos));
00425    m_pos += 4;
00426    __asm{
00427       mov eax, tempLong
00428       bswap eax <span class="comment">// ntohl, not for i386 and below.</span>
00429       mov tempLong, eax
00430    }
00431    <span class="keywordflow">return</span> tempLong;
00432 <span class="preprocessor">#else</span>
00433 <span class="preprocessor"></span>   <span class="comment">// Read and convert data</span>
00434    <a class="code" href="Types_8h.html#a21">uint32</a> tempLong = ntohl( *((<a class="code" href="Types_8h.html#a21">uint32</a> *)m_pos));
00435    m_pos += 4;
00436    <span class="keywordflow">return</span> tempLong;
00437 <span class="preprocessor">#endif</span>
00438 <span class="preprocessor"></span>}
00439 
00440 <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a21">uint32</a> 
<a name="l00441"></a><a class="code" href="classDataBuffer.html#a7">00441</a> <a class="code" href="classDataBuffer.html#a7">DataBuffer::readNextLong</a>() 
00442 {
00443    <span class="comment">// Align to long</span>
00444    <a class="code" href="namespaceAlignUtility.html#a4">AlignUtility::alignLong</a>(m_pos);
00445 
00446    <span class="keywordflow">return</span> <a class="code" href="classDataBuffer.html#a11">readNextLongAligned</a>();
00447 }
00448 
00449 
00450 <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a26">float32</a>
<a name="l00451"></a><a class="code" href="classDataBuffer.html#a8">00451</a> <a class="code" href="classDataBuffer.html#a8">DataBuffer::readNextFloat</a>() {
00452    <a class="code" href="namespaceAlignUtility.html#a4">AlignUtility::alignLong</a>(m_pos);
00453    <a class="code" href="Types_8h.html#a21">uint32</a> l = <a class="code" href="classDataBuffer.html#a11">readNextLongAligned</a>();
00454    <span class="keywordflow">return</span> *reinterpret_cast&lt;float32*&gt;(&amp;l);
00455 }
00456 
00457 <span class="keyword">template</span>&lt;<span class="keyword">class</span> TYPE&gt;
00458 <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00459"></a><a class="code" href="classDataBuffer.html#a9">00459</a> <a class="code" href="classDataBuffer.html#a7">DataBuffer::readNextLong</a>(TYPE&amp; value)
00460 {
00461    value = static_cast&lt;TYPE&gt;(<a class="code" href="classDataBuffer.html#a7">readNextLong</a>());
00462 }
00463 
00464 <span class="keyword">template</span>&lt;<span class="keyword">class</span> TYPE&gt;
00465 <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00466"></a><a class="code" href="classDataBuffer.html#a10">00466</a> <a class="code" href="classDataBuffer.html#a11">DataBuffer::readNextLongAligned</a>(TYPE&amp; value)
00467 {
00468    value = static_cast&lt;TYPE&gt;(<a class="code" href="classDataBuffer.html#a11">readNextLongAligned</a>());
00469 }
00470 
00471 
00472 <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a21">uint32</a> 
<a name="l00473"></a><a class="code" href="classDataBuffer.html#a12">00473</a> <a class="code" href="classDataBuffer.html#a12">DataBuffer::readLong</a>(uint32 index)
00474 {
00475    <span class="keywordflow">return</span> ntohl( *((<a class="code" href="Types_8h.html#a21">uint32</a> *) (m_buf+index) ));
00476 }
00477 
00478 <span class="keyword">inline</span> 
<a name="l00479"></a><a class="code" href="classDataBuffer.html#a14">00479</a> <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a14">DataBuffer::writeNextFloat</a>(float32 data) { 
00480    <a class="code" href="namespaceAlignUtility.html#a4">AlignUtility::alignLong</a>( m_pos );
00481 
00482    *( (<a class="code" href="Types_8h.html#a21">uint32</a>*)(m_pos) ) = htonl( *reinterpret_cast&lt;uint32*&gt;(&amp;data) );
00483    m_pos += 4;
00484 }
00485 
00486 <span class="keyword">inline</span> 
<a name="l00487"></a><a class="code" href="classDataBuffer.html#a13">00487</a> <span class="keywordtype">void</span> <a class="code" href="classDataBuffer.html#a13">DataBuffer::writeNextLong</a>(uint32 data) 
00488 {
00489    <span class="comment">// Align to long</span>
00490    <a class="code" href="namespaceAlignUtility.html#a4">AlignUtility::alignLong</a>(m_pos);
00491 
00492 <span class="preprocessor">#ifdef _DEBUG</span>
00493 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a37">almostAssert</a>(!( m_pos &gt; (m_buf + m_bufSize)));
00494    <a class="code" href="config_8h.html#a37">almostAssert</a>(data != 0xcdcdcdcd); <span class="comment">// might be uninitialized.</span>
00495 <span class="preprocessor">#endif</span>
00496 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a8">DEBUG1</a>( <span class="keywordflow">if</span>( m_pos &gt; (m_buf + m_bufSize) ) {
00497       <a class="code" href="classDataBuffer.html#b0">outsideBufferErrorPrint</a>(<span class="stringliteral">"writeNextLong"</span>);
00498    } );
00499       
00500    <span class="comment">// Convert and write data</span>
00501    * ( (<a class="code" href="Types_8h.html#a21">uint32</a>*)m_pos ) = htonl(data);
00502    m_pos += 4;
00503 
00504 }
00505 
00506 <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a19">uint16</a> 
<a name="l00507"></a><a class="code" href="classDataBuffer.html#a19">00507</a> <a class="code" href="classDataBuffer.html#a19">DataBuffer::readNextShortAligned</a>() 
00508 {
00509    <a class="code" href="config_8h.html#a37">almostAssert</a>((uintptr_t(m_pos) &amp; 1) == 0);
00510 <span class="preprocessor">#ifdef _DEBUG</span>
00511 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a37">almostAssert</a>(!( m_pos &gt; (m_buf + m_bufSize)));
00512 <span class="preprocessor">#endif</span>
00513 <span class="preprocessor"></span><span class="preprocessor">#ifdef _WIN32</span>
00514 <span class="preprocessor"></span>   <a class="code" href="Types_8h.html#a19">uint16</a> tempShort = *(reinterpret_cast&lt;uint16*&gt;(m_pos));
00515    m_pos += 2;
00516    __asm{
00517       mov ax, tempShort
00518       bswap eax  <span class="comment">// ntohl</span>
00519       shr eax, 16 <span class="comment">// the result ended up in the higher part of eax. move it to lower part.</span>
00520       mov tempShort, ax
00521    }
00522    <span class="keywordflow">return</span> tempShort;
00523 <span class="preprocessor">#else</span>
00524 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a8">DEBUG1</a>( <span class="keywordflow">if</span>( m_pos &gt; (m_buf + m_bufSize) ) {
00525       <a class="code" href="classDataBuffer.html#b0">outsideBufferErrorPrint</a>(<span class="stringliteral">"readNextShort"</span>);
00526    } );
00527 
00528    
00529    <a class="code" href="Types_8h.html#a19">uint16</a> tempShort = ntohs(*((<a class="code" href="Types_8h.html#a19">uint16</a> *)m_pos));
00530    m_pos += 2;
00531 <span class="preprocessor">#endif</span>
00532 <span class="preprocessor"></span>   <span class="keywordflow">return</span> tempShort;
00533 }
00534 
00535 <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a19">uint16</a> 
<a name="l00536"></a><a class="code" href="classDataBuffer.html#a16">00536</a> <a class="code" href="classDataBuffer.html#a16">DataBuffer::readNextShort</a>() 
00537 {
00538    <span class="comment">// Align to short</span>
00539    <a class="code" href="namespaceAlignUtility.html#a0">AlignUtility::alignShort</a>(m_pos);
00540 
00541    <span class="keywordflow">return</span> <a class="code" href="classDataBuffer.html#a19">readNextShortAligned</a>();
00542 }
00543 
00544 
00545 <span class="keyword">template</span>&lt;<span class="keyword">class</span> TYPE&gt;
00546 <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00547"></a><a class="code" href="classDataBuffer.html#a17">00547</a> <a class="code" href="classDataBuffer.html#a16">DataBuffer::readNextShort</a>(TYPE&amp; value)
00548 {
00549    value = static_cast&lt;TYPE&gt;(<a class="code" href="classDataBuffer.html#a16">readNextShort</a>());
00550 }
00551 
00552 <span class="keyword">template</span>&lt;<span class="keyword">class</span> TYPE&gt;
00553 <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00554"></a><a class="code" href="classDataBuffer.html#a18">00554</a> <a class="code" href="classDataBuffer.html#a19">DataBuffer::readNextShortAligned</a>(TYPE&amp; value)
00555 {
00556    value = static_cast&lt;TYPE&gt;(<a class="code" href="classDataBuffer.html#a19">readNextShortAligned</a>());
00557 }
00558 
00559 
00560 <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a19">uint16</a> 
<a name="l00561"></a><a class="code" href="classDataBuffer.html#a20">00561</a> <a class="code" href="classDataBuffer.html#a20">DataBuffer::readShort</a>(uint32 index)
00562 {
00563    <span class="keywordflow">return</span> ntohs(*((<a class="code" href="Types_8h.html#a19">uint16</a> *) (m_buf+index) ));
00564 }
00565 
00566 
00567 <span class="keyword">inline</span> <span class="keywordtype">void</span> 
<a name="l00568"></a><a class="code" href="classDataBuffer.html#a21">00568</a> <a class="code" href="classDataBuffer.html#a21">DataBuffer::writeNextShort</a>(uint16 data) 
00569 {
00570    <span class="comment">// Align to short</span>
00571    <a class="code" href="namespaceAlignUtility.html#a0">AlignUtility::alignShort</a>(m_pos);
00572 
00573 <span class="preprocessor">#ifdef _DEBUG</span>
00574 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a37">almostAssert</a>(!( m_pos &gt; (m_buf + m_bufSize)));
00575    <a class="code" href="config_8h.html#a37">almostAssert</a>(data  != 0xcdcd); <span class="comment">// might be uninitialized.</span>
00576 <span class="preprocessor">#endif</span>
00577 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a8">DEBUG1</a>( <span class="keywordflow">if</span>( m_pos  &gt; (m_buf + m_bufSize) ) {
00578       <a class="code" href="classDataBuffer.html#b0">outsideBufferErrorPrint</a>(<span class="stringliteral">"writeNextShort"</span>);
00579    } );
00580 
00581    <span class="comment">// Convert and write data</span>
00582    *((<a class="code" href="Types_8h.html#a19">uint16</a> *)m_pos) = htons(data);
00583    m_pos += 2;
00584 }   
00585 
00586 
00587 
00588 <span class="keyword">inline</span> <a class="code" href="Types_8h.html#a25">byte</a> 
<a name="l00589"></a><a class="code" href="classDataBuffer.html#a23">00589</a> <a class="code" href="classDataBuffer.html#a23">DataBuffer::readNextByte</a>() 
00590 {
00591 <span class="preprocessor">#ifdef _DEBUG</span>
00592 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a37">almostAssert</a>(!( m_pos &gt; (m_buf + m_bufSize)));
00593 <span class="preprocessor">#endif</span>
00594 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a8">DEBUG1</a>( <span class="keywordflow">if</span>( m_pos &gt; (m_buf + m_bufSize)) {
00595       <a class="code" href="classDataBuffer.html#b0">outsideBufferErrorPrint</a>(<span class="stringliteral">"readNextByte"</span>);
00596    } );
00597 
00598    <span class="comment">// No alignment necessary</span>
00599    <span class="keywordflow">return</span> *m_pos++;
00600 }
00601 
00602 
00603 <span class="keyword">inline</span> <span class="keywordtype">bool</span>
<a name="l00604"></a><a class="code" href="classDataBuffer.html#a27">00604</a> <a class="code" href="classDataBuffer.html#a27">DataBuffer::readNextBool</a>()  
00605 {
00606    <span class="keywordflow">return</span> <a class="code" href="classDataBuffer.html#a23">readNextByte</a>() != 0;
00607 }
00608 
00609 
00610 <span class="keyword">inline</span> <span class="keywordtype">void</span> 
<a name="l00611"></a><a class="code" href="classDataBuffer.html#a24">00611</a> <a class="code" href="classDataBuffer.html#a24">DataBuffer::writeNextByte</a>(uint8 data) 
00612 {
00613    <span class="comment">// No alignment necessary</span>
00614    
00615    <span class="comment">//Convert and write data</span>
00616 <span class="preprocessor">#ifdef _DEBUG</span>
00617 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a37">almostAssert</a>(!( m_pos &gt; (m_buf + m_bufSize)));
00618 <span class="preprocessor">#endif</span>
00619 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a8">DEBUG1</a>( <span class="keywordflow">if</span>( m_pos  &gt; (m_buf + m_bufSize)) {
00620       <a class="code" href="classDataBuffer.html#b0">outsideBufferErrorPrint</a>(<span class="stringliteral">"writeNextByte"</span>);
00621    } );
00622     
00623    *m_pos++ = data;
00624 }
00625 
00626 <span class="comment">// ========================================================================</span>
00627 <span class="comment">//                                                 DataBufferChecker      =</span>
00628 
<a name="l00644"></a><a class="code" href="classDataBufferChecker.html">00644</a> <span class="keyword">class </span><a class="code" href="classDataBufferChecker.html">DataBufferChecker</a> {
00645   <span class="keyword">public</span>:
00652    <span class="keyword">inline</span> <a class="code" href="classDataBufferChecker.html">DataBufferChecker</a>(<span class="keyword">const</span> <a class="code" href="classDataBuffer.html">DataBuffer</a>&amp; db, <span class="keyword">const</span> <span class="keywordtype">char</span>* dbgStr = NULL);
00653 
00660    <span class="keyword">inline</span> <span class="keywordtype">void</span> assertRoom(<a class="code" href="Types_8h.html#a21">uint32</a> nbrBytes);
00661 
00667    <span class="keyword">inline</span> <span class="keywordtype">void</span> assertPosition(<a class="code" href="Types_8h.html#a21">uint32</a> offset);
00668   <span class="keyword">private</span>:
00669 <span class="preprocessor">#ifndef RELEASE_VERSION   </span>
00670 <span class="preprocessor"></span>
<a name="l00671"></a><a class="code" href="classDataBufferChecker.html#r0">00671</a>    <span class="keyword">const</span> <a class="code" href="classDataBuffer.html">DataBuffer</a>&amp; m_db;
00672 
<a name="l00674"></a><a class="code" href="classDataBufferChecker.html#r1">00674</a>    <a class="code" href="Types_8h.html#a21">uint32</a> m_startOffset;
00675 
<a name="l00677"></a><a class="code" href="classDataBufferChecker.html#r2">00677</a>    <span class="keyword">const</span> <span class="keywordtype">char</span>* m_dbgStr;
00678 <span class="preprocessor">#endif</span>
00679 <span class="preprocessor"></span>};
00680 
00681 <span class="keyword">inline</span>
<a name="l00682"></a><a class="code" href="classDataBufferChecker.html#a0">00682</a> <a class="code" href="classDataBufferChecker.html#a0">DataBufferChecker::DataBufferChecker</a>(<span class="keyword">const</span> <a class="code" href="classDataBuffer.html">DataBuffer</a>&amp; db, <span class="keyword">const</span> <span class="keywordtype">char</span>* dbgStr)
00683 #ifndef RELEASE_VERSION
00684       : m_db(db), m_startOffset(db.getCurrentOffset()), m_dbgStr(dbgStr)
00685 #endif
00686 {
00687 }
00688 
00689 <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00690"></a><a class="code" href="classDataBufferChecker.html#a1">00690</a> <a class="code" href="classDataBufferChecker.html#a1">DataBufferChecker::assertRoom</a>(uint32 nbrBytes)
00691 {
00692 <span class="preprocessor">#ifndef RELEASE_VERSION</span>
00693 <span class="preprocessor"></span>   <span class="keywordtype">bool</span> condition =
00694       <a class="code" href="classDataBufferChecker.html#r0">m_db</a>.<a class="code" href="classSharedBuffer.html#a27">getBufferSize</a>() &gt;= (<a class="code" href="classDataBufferChecker.html#r0">m_db</a>.<a class="code" href="classSharedBuffer.html#a28">getCurrentOffset</a>() + nbrBytes);
00695    <span class="keywordflow">if</span> ( <a class="code" href="classDataBufferChecker.html#r2">m_dbgStr</a> &amp;&amp; ! condition ) {
00696       <a class="code" href="MC2Logging_8h.html#a2">mc2dbg</a> &lt;&lt; <span class="stringliteral">"[DataBufferChecker]: "</span> &lt;&lt; <a class="code" href="classDataBufferChecker.html#r2">m_dbgStr</a>
00697              &lt;&lt; <span class="stringliteral">"Not enough room for "</span>
00698              &lt;&lt; nbrBytes &lt;&lt; <span class="stringliteral">" more bytes "</span> &lt;&lt; endl;
00699    }
00700    <a class="code" href="config_8h.html#a29">MC2_ASSERT</a>( condition );
00701 <span class="preprocessor">#endif</span>
00702 <span class="preprocessor"></span>}
00703 
00704 <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00705"></a><a class="code" href="classDataBufferChecker.html#a2">00705</a> <a class="code" href="classDataBufferChecker.html#a2">DataBufferChecker::assertPosition</a>(uint32 offset)
00706 {
00707 <span class="preprocessor">#ifndef RELEASE_VERSION</span>
00708 <span class="preprocessor"></span>   <span class="keywordtype">bool</span> condition = offset == (<a class="code" href="classDataBufferChecker.html#r0">m_db</a>.<a class="code" href="classSharedBuffer.html#a28">getCurrentOffset</a>() - m_startOffset);
00709    <span class="keywordflow">if</span> ( <a class="code" href="classDataBufferChecker.html#r2">m_dbgStr</a> &amp;&amp; ! condition ) {
00710       <a class="code" href="MC2Logging_8h.html#a2">mc2dbg</a> &lt;&lt; <span class="stringliteral">"[DataBufferChecker]: Position from start in "</span>
00711              &lt;&lt; <a class="code" href="classDataBufferChecker.html#r2">m_dbgStr</a> &lt;&lt; <span class="stringliteral">" is "</span>
00712              &lt;&lt; (<a class="code" href="classDataBufferChecker.html#r0">m_db</a>.<a class="code" href="classSharedBuffer.html#a28">getCurrentOffset</a>() - m_startOffset) &lt;&lt; <span class="stringliteral">" but should be "</span>
00713              &lt;&lt; offset &lt;&lt; endl;
00714    }
00715    <a class="code" href="config_8h.html#a29">MC2_ASSERT</a>( condition );
00716 <span class="preprocessor">#endif</span>
00717 <span class="preprocessor"></span>}
00718 
00719 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jun 30 10:11:46 2010 for mc2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
