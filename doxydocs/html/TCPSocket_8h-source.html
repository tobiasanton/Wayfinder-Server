<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mc2: TCPSocket.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">Shared</a>&nbsp;/&nbsp;<a class="el" href="dir_000051.html">Net</a>&nbsp;/&nbsp;<a class="el" href="dir_000052.html">include</a></div>
<h1>TCPSocket.h</h1><a href="TCPSocket_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 1999 - 2010, Vodafone Group Services Ltd</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
00008 <span class="comment">    * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
00009 <span class="comment">    * Neither the name of the Vodafone Group Services Ltd nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</span>
00010 <span class="comment"></span>
00011 <span class="comment">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00012 <span class="comment">*/</span>
00013 
00014 <span class="preprocessor">#ifndef TCPSOCKET_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#define TCPSOCKET_H</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#include "<a class="code" href="config_8h.html">config.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="Socket_8h.html">Socket.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="SysUtility_8h.html">SysUtility.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="StepLogger_8h.html">StepLogger.h</a>"</span>
00021 
00022 <span class="keyword">class </span><a class="code" href="classIPnPort.html">IPnPort</a>;
00023 
<a name="l00024"></a><a class="code" href="TCPSocket_8h.html#a0">00024</a> <span class="preprocessor">#define DEFAULT_BACKLOG 5</span>
00025 <span class="preprocessor"></span>
<a name="l00036"></a><a class="code" href="classTCPSocket.html">00036</a> <span class="keyword">class </span><a class="code" href="classTCPSocket.html">TCPSocket</a> : <span class="keyword">public</span> <a class="code" href="classSocket.html">Socket</a>, <span class="keyword">public</span> <a class="code" href="classWriteable.html">Writeable</a>, <span class="keyword">public</span> <a class="code" href="classReadable.html">Readable</a>,
00037                   <span class="keyword">public</span> <a class="code" href="classStepLogger.html">StepLogger</a>
00038 {   
00039    <span class="keyword">public</span>:
<a name="l00046"></a><a class="code" href="classTCPSocket.html#w7">00046</a>       <span class="keyword">enum</span> <a class="code" href="classTCPSocket.html#w7">TCPPortChoice</a> {GENERIC, <a class="code" href="classTCPSocket.html#w7w1">FINDFREEPORT</a>};
00047 
<a name="l00051"></a><a class="code" href="classTCPSocket.html#w8">00051</a>       <span class="keyword">enum</span> <a class="code" href="classTCPSocket.html#w8">TCPSocketState</a> {
00053          UNKNOWN, 
00054          
00056          OPEN, 
00057          
00059          LISTEN, 
00060          
00062          CONNECTED, 
00063          
00065          <a class="code" href="classTCPSocket.html#w8w6">CLOSED</a> };
00066 
00070       <a class="code" href="classTCPSocket.html#a0">TCPSocket</a>();
00071 
00078       <a class="code" href="classTCPSocket.html#a0">TCPSocket</a>(<span class="keywordtype">int</span> backlog);
00079 
00083       <span class="keyword">virtual</span> <a class="code" href="classTCPSocket.html#a2">~TCPSocket</a>();
00084 
00090       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a3">open</a>();
00091 
00098       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a4">bind</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *hostname);
00099 
00106       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a4">bind</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *hostname, uint16 portNumber);
00107 
00111       <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classTCPSocket.html#a6">close</a>();
00112 
00123       <span class="keyword">virtual</span> <a class="code" href="Types_8h.html#a19">uint16</a> <a class="code" href="classTCPSocket.html#a7">listen</a>(uint16 portnumber, TCPPortChoice pc = GENERIC,
00124                             <span class="keywordtype">bool</span> bindSocket = <span class="keyword">true</span> );
00125 
00134       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a8">listenDuration</a>( uint16 port, uint32 duration = 1,
00135                                    <span class="keywordtype">bool</span> bindSocket = <span class="keyword">true</span> );
00136 
00147       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a9">connect</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *hostname, <span class="keywordtype">int</span> portnumber);
00148 
00161       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a9">connect</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *hostname, <span class="keywordtype">int</span> portnumber, uint32 timeout_us);
00162 
00171       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a9">connect</a>(<span class="keyword">const</span> <a class="code" href="classIPnPort.html">IPnPort</a>&amp; addr, uint32 timeout_us);
00172 
00182       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a9">connect</a>(uint32 hostip, uint16 hostport);
00183 
00184 
<a name="l00189"></a><a class="code" href="TCPSocket_8h.html#a1">00189</a> <span class="preprocessor">      #define TCPSOCKET_DEFAULT_TIMEOUT (10 * 60 * 1000000)</span>
00190 <span class="preprocessor"></span>      
<a name="l00194"></a><a class="code" href="TCPSocket_8h.html#a2">00194</a> <span class="preprocessor">      #define TCPSOCKET_INFINITE_TIMEOUT (-1)</span>
00195 <span class="preprocessor"></span>
00199       <span class="keywordtype">int</span> <a class="code" href="classTCPSocket.html#a13">setNoDelay</a>(<span class="keywordtype">bool</span> noDelay);
00200 
00211       <span class="keyword">virtual</span> ssize_t <a class="code" href="classTCPSocket.html#a14">read</a>( byte* buffer, size_t size );
00212 
00213 
00226       <span class="keyword">virtual</span> ssize_t <a class="code" href="classTCPSocket.html#a14">read</a>( byte* buffer, size_t size, uint32 timeout );
00227 
00228 
00262       <span class="keyword">virtual</span> ssize_t <a class="code" href="classTCPSocket.html#a16">readExactly</a>(byte *buffer,
00263                            size_t length,
00264                            <span class="keywordtype">long</span> micros = TCPSOCKET_INFINITE_TIMEOUT,
00265                            <span class="keywordtype">long</span> totalMicros = TCPSOCKET_INFINITE_TIMEOUT);
00266 
00279       ssize_t <a class="code" href="classTCPSocket.html#a17">readMaxBytes</a>( byte *buffer, 
00280                             size_t length, 
00281                             uint32 micros );
00282       
00299       <span class="keyword">inline</span> <span class="keyword">virtual</span> ssize_t <a class="code" href="classTCPSocket.html#a17">readMaxBytes</a>(byte *buffer, size_t length);
00300 
00316       <span class="keyword">virtual</span> ssize_t <a class="code" href="classTCPSocket.html#a19">readUntilClosed</a>(byte *buffer, size_t length);
00317       
00318 
00329        <span class="keyword">virtual</span> ssize_t <a class="code" href="classTCPSocket.html#a20">write</a>( <span class="keyword">const</span> byte *buffer, size_t length );
00330 
00331 
00345        <span class="keyword">virtual</span> ssize_t <a class="code" href="classTCPSocket.html#a20">write</a>( <span class="keyword">const</span> byte *buffer, size_t length,
00346                               uint32 timeout );
00347 
00348 
00359       <span class="keyword">virtual</span> ssize_t <a class="code" href="classTCPSocket.html#a22">writeAll</a>(<span class="keyword">const</span> byte *buffer, size_t length);
00360 
00367       <span class="keyword">virtual</span> <a class="code" href="classTCPSocket.html">TCPSocket</a>* <a class="code" href="classTCPSocket.html#a23">accept</a>();
00368 
00376       <a class="code" href="classTCPSocket.html">TCPSocket</a>* <a class="code" href="classTCPSocket.html#a23">accept</a>(uint32 micros);
00377       
00387       <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a25">getPeerName</a>(uint32&amp; <a class="code" href="classIP.html">IP</a>, uint16&amp; port) <span class="keyword">const</span>;
00388 
00393       <a class="code" href="classIPnPort.html">IPnPort</a> <a class="code" href="classTCPSocket.html#a26">getPeer</a>() <span class="keyword">const</span>;
00394 
00404       <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a27">getSockName</a>(uint32&amp; <a class="code" href="classIP.html">IP</a>, uint16&amp; port);
00405 
00414       <span class="keyword">virtual</span> <a class="code" href="Types_8h.html#a22">int32</a> <a class="code" href="classTCPSocket.html#a28">readString</a>(<span class="keywordtype">char</span>* target, uint32 maxstringlength);
00415 
00424       <span class="keyword">virtual</span> <a class="code" href="Types_8h.html#a22">int32</a> <a class="code" href="classTCPSocket.html#a29">readLine</a>(<span class="keywordtype">char</span>* target, uint32 maxlinelength);
00425 
00430       TCPSocketState <a class="code" href="classTCPSocket.html#a30">getState</a>() <span class="keyword">const</span>;
00431 
00437       <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="classTCPSocket.html#a31">getStateAsString</a>() <span class="keyword">const</span>;
00438 
00449       <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a32">setBlocking</a>(<span class="keywordtype">bool</span> blocking);
00450 
00451    
00457       <a class="code" href="classTCPSocket.html#a0">TCPSocket</a>(SOCKET sock, <span class="keywordtype">int</span> backlog);
00458 
00459 
00469       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a34">initialHandshake</a>( 
00470          <span class="keywordtype">long</span> micros = TCPSOCKET_INFINITE_TIMEOUT );
00471 
00472 
00479       <span class="keyword">virtual</span> <span class="keywordtype">int</span> <a class="code" href="classTCPSocket.html#a35">initialHandshaking</a>();
00480 
00481    <span class="keyword">protected</span>:
<a name="l00485"></a><a class="code" href="classTCPSocket.html#p0">00485</a>       <span class="keywordtype">bool</span> m_blocking;
00486    
<a name="l00490"></a><a class="code" href="classTCPSocket.html#p1">00490</a>       <a class="code" href="classTCPSocket.html#w8">TCPSocketState</a> m_currentState;
00491 
00492 
<a name="l00496"></a><a class="code" href="classTCPSocket.html#p2">00496</a>       <span class="keywordtype">int</span> m_backlog;
00497       
00498       
<a name="l00508"></a><a class="code" href="classTCPSocket.html#t0">00508</a>       <span class="keyword">static</span> <span class="keywordtype">int</span> c_tcp_proto_nbr;
00509 
00520       <span class="keyword">virtual</span> ssize_t <a class="code" href="classTCPSocket.html#b0">readMinMaxBytesWithTimeout</a>(byte* buffer,
00521                                                  size_t minLength,
00522                                                  size_t maxLength,
00523                                                  <span class="keywordtype">long</span> micros,
00524                                                  <span class="keywordtype">long</span> totalMicros);
00525       
00535       <span class="keyword">virtual</span> ssize_t <a class="code" href="classTCPSocket.html#b1">protectedRead</a>( byte* buffer,
00536                                      size_t size );
00537       
00545       <span class="keyword">virtual</span> ssize_t <a class="code" href="classTCPSocket.html#b2">protectedWrite</a>( <span class="keyword">const</span> byte* buffer,
00546                                       size_t size );
00547 
00548    
00549      
00550 
00561       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#b3">checkForCachedData</a>( byte* buffer, size_t size );
00562 
00569       <span class="keyword">virtual</span> SOCKET <a class="code" href="classTCPSocket.html#b4">internalAccept</a>();
00570 
00571    <span class="keyword">private</span>:
00578       <span class="keywordtype">void</span> <a class="code" href="classTCPSocket.html#d0">init</a>(SOCKET sock, <span class="keywordtype">int</span> backlog = DEFAULT_BACKLOG);
00579 
00585       <span class="keywordtype">void</span> <a class="code" href="classTCPSocket.html#d1">setupSocket</a>();
00591        <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a9">connect</a>(<span class="keyword">struct</span> sockaddr_in &amp;sin);
00596        <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#d3">waitForConnect</a>(uint32 timeout_us);
00597 };
00598 
00599 
00600 <span class="keyword">inline</span> ssize_t
<a name="l00601"></a><a class="code" href="classTCPSocket.html#a18">00601</a> <a class="code" href="classTCPSocket.html#a17">TCPSocket::readMaxBytes</a>(  byte *buffer,
00602                           size_t size  )
00603 {
00604 <span class="preprocessor">#ifndef _MSC_VER</span>
00605 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a6">DEBUG4</a>(cerr &lt;&lt; <span class="stringliteral">"TCPSocket::readMaxBytes(buffer = "</span> &lt;&lt; buffer
00606           &lt;&lt; <span class="stringliteral">", size = "</span> &lt;&lt; size &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl; );
00607 
00608    <span class="keywordflow">if</span> (m_sock == 0 ) {
00609       <a class="code" href="config_8h.html#a13">MC2ERROR</a>(<span class="stringliteral">"TCPSocket::readMaxBytes(byte*, size_t) - m_sock == 0"</span>);
00610       <span class="keywordflow">return</span> -1;
00611    }   
00612    <a class="code" href="namespaceSysUtility.html#a1">SysUtility::setPipeDefault</a>();
00613 <span class="preprocessor">#else</span>
00614 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a37">almostAssert</a>(m_sock != 0);
00615 <span class="preprocessor">#endif</span>
00616 <span class="preprocessor"></span>
00617    ssize_t result = <a class="code" href="classTCPSocket.html#b1">protectedRead</a>(buffer, size);
00618 
00619 <span class="preprocessor">#ifndef _MSC_VER</span>
00620 <span class="preprocessor"></span>   <a class="code" href="namespaceSysUtility.html#a1">SysUtility::setPipeDefault</a>();
00621 <span class="preprocessor">#endif</span>
00622 <span class="preprocessor"></span>   <span class="keywordflow">return</span> result;
00623 }
00624 
00625 <span class="keyword">inline</span> ssize_t
<a name="l00626"></a><a class="code" href="classTCPSocket.html#b1">00626</a> <a class="code" href="classTCPSocket.html#b1">TCPSocket::protectedRead</a>( byte* buffer,
00627                         size_t size )
00628 {
00629    size_t readLength;
00630 <span class="preprocessor">#ifndef _MSC_VER</span>
00631 <span class="preprocessor"></span><span class="preprocessor">#  ifdef EINTR</span>
00632 <span class="preprocessor"></span>   <span class="keywordflow">do</span> { <span class="comment">// Read until the error isn't EINTR</span>
00633       readLength = ::read(m_sock, buffer, size);
00634       <span class="keywordflow">if</span> ( readLength &lt; 0 &amp;&amp; errno == EINTR ) {
00635          <a class="code" href="config_8h.html#a14">MC2WARNING</a>(<span class="stringliteral">"TCPSocket::protectedRead - EINTR - trying again"</span>);
00636       }
00637    } <span class="keywordflow">while</span> ( readLength &lt; 0 &amp;&amp; errno == EINTR );
00638 <span class="preprocessor">#  else</span>
00639 <span class="preprocessor"></span>   readLength = ::read(m_sock, buffer, size);
00640 <span class="preprocessor">#  endif</span>
00641 <span class="preprocessor"></span>
00642 <span class="preprocessor">#else // IT IS _MSC_VER</span>
00643 <span class="preprocessor"></span>   readLength = ::recv(m_sock, (<span class="keywordtype">char</span> *)buffer, size, 0);
00644 <span class="preprocessor">#endif</span>
00645 <span class="preprocessor"></span>      <span class="keywordflow">return</span> readLength;
00646 }
00647 
00648 <span class="preprocessor">#endif // TCPSOCKET_H</span>
00649 <span class="preprocessor"></span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jun 30 10:11:51 2010 for mc2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
