<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mc2: ItemDataTable.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000002.html">Server</a>&nbsp;/&nbsp;<a class="el" href="dir_000005.html">Shared</a>&nbsp;/&nbsp;<a class="el" href="dir_000006.html">include</a></div>
<h1>ItemDataTable.h</h1><a href="ItemDataTable_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 1999 - 2010, Vodafone Group Services Ltd</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
00008 <span class="comment">    * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
00009 <span class="comment">    * Neither the name of the Vodafone Group Services Ltd nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</span>
00010 <span class="comment"></span>
00011 <span class="comment">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00012 <span class="comment">*/</span>
00013 
00014 <span class="preprocessor">#ifndef ITEMADA_ATA_TABLE_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#define ITEMADA_ATA_TABLE_H</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#include "<a class="code" href="config_8h.html">config.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="DataTable_8h.html">DataTable.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="ItemComboLoader_8h.html">ItemComboLoader.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="AlignUtility_8h.html">AlignUtility.h</a>"</span>
00021 <span class="preprocessor">#include "<a class="code" href="MapBits_8h.html">MapBits.h</a>"</span>
00022 
00023 <span class="keyword">class </span><a class="code" href="classDataBuffer.html">DataBuffer</a>;
00024 <span class="keyword">class </span><a class="code" href="classDataBufferChecker.html">DataBufferChecker</a>;
00025 
00026 <span class="preprocessor">#include &lt;map&gt;</span>
00027 <span class="preprocessor">#include &lt;algorithm&gt;</span>
00028 
00029 <span class="preprocessor">#include "<a class="code" href="NonStdStl_8h.html">NonStdStl.h</a>"</span>
00030 
00031 <span class="preprocessor">#undef URIT_USES_ZOOM_LEVELS</span>
00032 <span class="preprocessor"></span>
00033 
00039 <span class="keyword">template</span>&lt;<span class="keyword">class </span>VALUE_TYPE,
00040          <span class="keyword">class </span>VALUE_SAVER =
00041                   <span class="keyword">typename</span> <a class="code" href="classLoaderTypeSelector.html">LoaderTypeSelector&lt;VALUE_TYPE&gt;</a>::loaderType &gt;
<a name="l00042"></a><a class="code" href="classItemDataTable.html">00042</a> <span class="keyword">class </span><a class="code" href="classItemDataTable.html">ItemDataTable</a>: <span class="keyword">public</span> <a class="code" href="classDataTable.html">DataTable</a>&lt;VALUE_TYPE&gt; {
<a name="l00043"></a><a class="code" href="classItemDataTable.html#n0">00043</a>    <span class="keyword">friend</span> <span class="keyword">class </span><a class="code" href="classM3Creator.html">M3Creator</a>;
00044 <span class="keyword">private</span>:
00046    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;
<a name="l00047"></a><a class="code" href="structItemDataTable_1_1LessSecond.html">00047</a>    <span class="keyword">struct </span><a class="code" href="structItemDataTable_1_1LessSecond.html">LessSecond</a>:<span class="keyword">public</span> std::less&lt; T &gt; {
<a name="l00048"></a><a class="code" href="structItemDataTable_1_1LessSecond.html#a0">00048</a>       <span class="keywordtype">bool</span> <a class="code" href="structItemDataTable_1_1LessSecond.html#a0">operator () </a>(<span class="keyword">const</span> T&amp; a, <span class="keyword">const</span> T&amp; b)<span class="keyword"> const </span>{
00049          <span class="keywordflow">return</span> a.second &lt; b.second;
00050       }
00051    };
00052 
<a name="l00053"></a><a class="code" href="classItemDataTable.html#h0">00053</a>    <span class="keyword">static</span> <a class="code" href="Types_8h.html#a21">uint32</a> <a class="code" href="classItemDataTable.html#h0">GET_ZOOM</a>( uint32 itemID ) {
00054       <span class="keywordflow">return</span> (((itemID) &amp; 0x78000000) &gt;&gt; 27);
00055    }
00056    
<a name="l00057"></a><a class="code" href="classItemDataTable.html#h1">00057</a>    <span class="keyword">static</span> <a class="code" href="Types_8h.html#a21">uint32</a> <a class="code" href="classItemDataTable.html#h1">GET_POS_IN_ZOOM</a>( uint32 itemID ) {
00058       <span class="keywordflow">return</span> ( (itemID) &amp; 0x07ffffff);
00059    }
00060   <span class="keyword">public</span>:
<a name="l00062"></a><a class="code" href="classItemDataTable.html#w0">00062</a>    <span class="keyword">typedef</span> <a class="code" href="classmap.html">map&lt;uint32, VALUE_TYPE&gt;</a> <a class="code" href="classmap.html">itemMap_t</a>;
00063    
<a name="l00067"></a><a class="code" href="classItemDataTable.html#a0">00067</a>    <a class="code" href="classItemDataTable.html#a0">ItemDataTable</a>( <span class="keyword">const</span> VALUE_TYPE&amp; defaultVal ) {
00068       m_defaultVal = defaultVal;
00069       <a class="code" href="classItemDataTable.html#d0">init</a>();
00070    }
00071 
<a name="l00079"></a><a class="code" href="classItemDataTable.html#a1">00079</a>    <a class="code" href="classItemDataTable.html#a0">ItemDataTable</a>( <span class="keyword">const</span> VALUE_TYPE&amp; defaultVal,
00080                   <span class="keyword">const</span> <a class="code" href="classmap.html">itemMap_t</a>&amp; itemsToAdd ) {
00081       m_defaultVal = defaultVal;
00082       <a class="code" href="classItemDataTable.html#d0">init</a>();
00083       <a class="code" href="classItemDataTable.html#a8">setData</a>( itemsToAdd );
00084    }
00085    
<a name="l00087"></a><a class="code" href="classItemDataTable.html#a2">00087</a>    <span class="keyword">virtual</span> <a class="code" href="classItemDataTable.html#a2">~ItemDataTable</a>() {
00088       <a class="code" href="classItemDataTable.html#a10">clear</a>();
00089    }
00090 
<a name="l00092"></a><a class="code" href="classItemDataTable.html#a3">00092</a>    <span class="keyword">const</span> VALUE_TYPE&amp; <a class="code" href="classItemDataTable.html#a3">getDefault</a>()<span class="keyword"> const </span>{
00093       <span class="keywordflow">return</span> m_defaultVal;
00094    }
00095 
<a name="l00096"></a><a class="code" href="classItemDataTable.html#a4">00096</a>    <span class="keywordtype">void</span> <a class="code" href="classItemDataTable.html#a4">setValues</a>( <span class="keyword">const</span> VALUE_TYPE&amp; defaultVal, 
00097                    <span class="keyword">const</span> <a class="code" href="classmap.html">itemMap_t</a>&amp; items ) {
00098       m_defaultVal = defaultVal;
00099       <a class="code" href="classItemDataTable.html#d0">init</a>();
00100       <a class="code" href="classItemDataTable.html#a8">setData</a>( items );
00101    }
00102 
<a name="l00103"></a><a class="code" href="classItemDataTable.html#a5">00103</a>    <span class="keyword">const</span> VALUE_TYPE&amp; <a class="code" href="classItemDataTable.html#a5">getData</a>( uint32 itemID )<span class="keyword"> const </span>{
00104 <span class="preprocessor">#ifndef URIT_USES_ZOOM_LEVELS</span>
00105 <span class="preprocessor"></span>      <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a>* begin = m_items;
00106       <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a>* end   = m_items + m_nbrItems;
00107       <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a>* <a class="code" href="RouteRequestData_8h.html#a3a1">item</a> = std::lower_bound( begin,
00108                                              end,
00109                                              itemID );
00110       <span class="keywordflow">if</span> ( <a class="code" href="RouteRequestData_8h.html#a3a1">item</a> == end || *<a class="code" href="RouteRequestData_8h.html#a3a1">item</a> != itemID ) {
00111          <span class="keywordflow">return</span> m_defaultVal;
00112       } <span class="keywordflow">else</span> {
00113          <span class="keywordflow">return</span> m_itemDatas[ <a class="code" href="RouteRequestData_8h.html#a3a1">item</a> - begin ];
00114       }
00115 <span class="preprocessor">#else</span>
00116 <span class="preprocessor"></span>      <a class="code" href="Types_8h.html#a21">uint32</a> zoom = <a class="code" href="classItemDataTable.html#h0">GET_ZOOM</a>( itemID );
00117       
00118       <span class="keywordflow">if</span> ( m_nbrItemsInZoom[zoom] == 0 ) {
00119          <span class="keywordflow">return</span> m_defaultVal;
00120       }
00121    
00122       <span class="keywordtype">int</span> pos  = <a class="code" href="classItemDataTable.html#h1">GET_POS_IN_ZOOM</a>( itemID ) - m_zoomOffsets[zoom];
00123       
00124       <span class="keywordflow">if</span> ( pos &lt; 0 || pos &gt;= m_nbrItemsInZoom[zoom] ) {
00125          <span class="comment">// It was before the first one.</span>
00126          <span class="keywordflow">return</span> m_defaultVal;
00127       } <span class="keywordflow">else</span> {
00128          <span class="keywordflow">return</span> m_dataPerZoom[zoom][pos];
00129       }
00130 <span class="preprocessor">#endif</span>
00131 <span class="preprocessor"></span>   }
00132 
<a name="l00133"></a><a class="code" href="classItemDataTable.html#a6">00133</a>    <span class="keywordtype">int</span> <a class="code" href="classItemDataTable.html#a6">getAllData</a>( <a class="code" href="classmap.html">itemMap_t</a>&amp; data )<span class="keyword"> const </span>{
00134 <span class="preprocessor">#ifndef URIT_USES_ZOOM_LEVELS</span>
00135 <span class="preprocessor"></span>      <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a>* begin = m_items;
00136       <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a>* end   = m_items + m_nbrItems;
00137       <span class="keywordflow">for</span> ( <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a>* it = begin;
00138             it != end;
00139             ++it ) {
00140          data.insert( make_pair( *it, <a class="code" href="classItemDataTable.html#a5">getData</a>(*it) ) );
00141       }
00142 <span class="preprocessor">#else</span>
00143 <span class="preprocessor"></span><span class="preprocessor">#error "Not implemented for zoom level storage"</span>
00144 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00145 <span class="preprocessor"></span>      <span class="keywordflow">return</span> data.size();
00146    }
00147    
<a name="l00148"></a><a class="code" href="classItemDataTable.html#a7">00148</a>    <span class="keywordtype">int</span> <a class="code" href="classItemDataTable.html#a6">getAllData</a>( <a class="code" href="classmap.html">itemMap_t</a>&amp; data, <span class="keyword">const</span> set&lt;uint32&gt;&amp; allowedItems )<span class="keyword"> const </span>{
00149 <span class="preprocessor">#ifndef URIT_USES_ZOOM_LEVELS</span>
00150 <span class="preprocessor"></span>      <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a>* begin = m_items;
00151       <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a>* end   = m_items + m_nbrItems;
00152       <span class="keywordflow">for</span> ( <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a>* it = begin;
00153             it != end;
00154             ++it ) {
00155          <span class="keywordflow">if</span> ( allowedItems.find( *it ) != allowedItems.end() ) {
00156             data.insert( make_pair( *it, <a class="code" href="classItemDataTable.html#a5">getData</a>(*it) ) );
00157          }
00158       }
00159 <span class="preprocessor">#else</span>
00160 <span class="preprocessor"></span><span class="preprocessor">#error "Not implemented for zoom level storage"</span>
00161 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00162 <span class="preprocessor"></span>      <span class="keywordflow">return</span> data.size();
00163    }
00164    
00170    <span class="keyword">template</span> &lt;<span class="keyword">typename</span> TYPE_ONE, <span class="keyword">typename</span> TYPE_TWO&gt;
<a name="l00171"></a><a class="code" href="classItemDataTable.html#e0">00171</a>    <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="classItemDataTable.html#e0">getCombinations</a>(<span class="keyword">const</span> std::map&lt;TYPE_ONE, TYPE_TWO&gt; &amp;items,
00172                                std::map&lt;TYPE_TWO, uint32&gt; &amp;combos ) {
00173 
00174       <span class="keyword">typename</span> std::map&lt;TYPE_ONE, TYPE_TWO&gt;::const_iterator it = items.begin();
00175       <span class="keyword">typename</span> std::map&lt;TYPE_ONE, TYPE_TWO&gt;::const_iterator it_end =
00176          items.end();
00177       <span class="keywordflow">for</span> ( ; it != it_end; ++it ) {
00178          combos[ it-&gt;second ]++;
00179       }
00180    }
00181 
00182    <span class="keyword">static</span> <span class="keyword">typename</span> itemMap_t::value_type
<a name="l00183"></a><a class="code" href="classItemDataTable.html#e1">00183</a>    <a class="code" href="classItemDataTable.html#e1">getBestDefaultValue</a>(<span class="keyword">const</span> <a class="code" href="classmap.html">itemMap_t</a> &amp;items) {
00184       <span class="comment">//</span>
00185       <span class="comment">// Calculate default value</span>
00186       <span class="comment">// by counting number of different combinations</span>
00187       <span class="comment">// and selecting the combination that has the most </span>
00188       <span class="comment">// counts to be the default value</span>
00189       <span class="comment">//</span>
00190 
00191       <span class="keyword">typedef</span> std::map&lt;VALUE_TYPE, uint32&gt; reverseItemMap_t;
00192       reverseItemMap_t counterMap;
00193 
00194       <a class="code" href="classItemDataTable.html#e0">getCombinations</a>( items, counterMap );
00195 
00196       <span class="keyword">typename</span> reverseItemMap_t::iterator max_it = 
00197          std::max_element( counterMap.begin(),
00198                            counterMap.end(),
00199                          LessSecond&lt;typename reverseItemMap_t::value_type&gt;() );
00200 
00201       <span class="keywordflow">return</span> make_pair( max_it-&gt;second, max_it-&gt;first );
00202    }
00203    
<a name="l00205"></a><a class="code" href="classItemDataTable.html#a8">00205</a>    <span class="keywordtype">int</span> <a class="code" href="classItemDataTable.html#a8">setData</a>( <span class="keyword">const</span> <a class="code" href="classmap.html">itemMap_t</a>&amp; itemsToAdd ) {
00206       <a class="code" href="classItemDataTable.html#a10">clear</a>();
00207 
00208       <span class="comment">// Count the items</span>
00209       m_nbrItems = 0;
00210       <span class="keywordflow">for</span>( <span class="keyword">typename</span> itemMap_t::const_iterator it = itemsToAdd.begin();
00211            it != itemsToAdd.end();
00212            ++it ) {
00213          <span class="keywordflow">if</span> ( it-&gt;second != m_defaultVal ) {
00214             ++m_nbrItems;
00215          }
00216       }
00217       
00218       <span class="comment">// Fill in the items</span>
00219       <a class="code" href="Types_8h.html#a21">uint32</a>* items  = <span class="keyword">new</span> <a class="code" href="Types_8h.html#a21">uint32</a>[ m_nbrItems ];
00220       VALUE_TYPE* tmpItemDatas = <span class="keyword">new</span> VALUE_TYPE[ m_nbrItems ];
00221       <span class="keywordtype">int</span> curNbr = 0;
00222       <span class="keywordflow">for</span>( <span class="keyword">typename</span> itemMap_t::const_iterator it = itemsToAdd.begin();
00223            it != itemsToAdd.end();
00224            ++it ) {
00225          <span class="keywordflow">if</span> ( it-&gt;second != m_defaultVal ) {
00226             items[ curNbr ]   = it-&gt;first;
00227             tmpItemDatas[ curNbr ] = it-&gt;second;
00228             ++curNbr;
00229          }
00230       }
00231       
00232 
00233       <span class="comment">// Count items per zoom</span>
00234       <a class="code" href="Types_8h.html#a21">uint32</a> lowestItemPerZoom[NUMBER_GFX_ZOOMLEVELS];
00235       <a class="code" href="Types_8h.html#a21">uint32</a> highestItemPerZoom[NUMBER_GFX_ZOOMLEVELS];
00236       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; NUMBER_GFX_ZOOMLEVELS; ++i ) {
00237          lowestItemPerZoom[i] = MAX_UINT32;
00238          highestItemPerZoom[i] = 0;
00239       }
00240       <span class="comment">// Make the items per zoom</span>
00241       <span class="keywordflow">for</span> ( <span class="keyword">typename</span> itemMap_t::const_iterator it = itemsToAdd.begin();
00242             it != itemsToAdd.end();
00243             ++it ) {
00244          <span class="keywordflow">if</span> ( it-&gt;second != m_defaultVal ) {
00245             <a class="code" href="Types_8h.html#a17">uint8</a> zoom = <a class="code" href="classItemDataTable.html#h0">GET_ZOOM</a>( it-&gt;first );         
00246             lowestItemPerZoom[zoom] = <a class="code" href="Utility_8h.html#a1">MIN</a>( lowestItemPerZoom[zoom],
00247                                            <a class="code" href="classItemDataTable.html#h1">GET_POS_IN_ZOOM</a>(it-&gt;first) );
00248             highestItemPerZoom[zoom] = <a class="code" href="Utility_8h.html#a2">MAX</a>( highestItemPerZoom[zoom],
00249                                             <a class="code" href="classItemDataTable.html#h1">GET_POS_IN_ZOOM</a>( it-&gt;first ) );
00250          }
00251       }
00252 
00253       <span class="comment">// Find out the number of items actually used per zoom.</span>
00254       <span class="keywordflow">for</span> ( <a class="code" href="Types_8h.html#a21">uint32</a> zoom = 0; zoom &lt; NUMBER_GFX_ZOOMLEVELS; ++zoom ) {
00255          <span class="keywordflow">if</span> ( lowestItemPerZoom[zoom] != MAX_UINT32 ) {
00256             m_nbrItemsInZoom[zoom] =
00257                highestItemPerZoom[zoom] - lowestItemPerZoom[zoom];
00258             ++m_nbrItemsInZoom[zoom];
00259          } <span class="keywordflow">else</span> {
00260             m_nbrItemsInZoom[zoom] = 0;
00261          }
00262       }
00263       
00264       VALUE_TYPE* dataPerZoom[NUMBER_GFX_ZOOMLEVELS];
00265       <span class="keywordflow">for</span> ( <a class="code" href="Types_8h.html#a21">uint32</a> zoom = 0; zoom &lt; NUMBER_GFX_ZOOMLEVELS; ++zoom ) {
00266          <span class="keywordtype">int</span> nbrForCurZoom = m_nbrItemsInZoom[zoom];
00267          m_zoomOffsets[zoom] = lowestItemPerZoom[zoom];
00268          <span class="keywordflow">if</span> ( 0 == nbrForCurZoom) {
00269             dataPerZoom[zoom] = NULL;
00270          } <span class="keywordflow">else</span> {
00271             <a class="code" href="MC2Logging_8h.html#a2">mc2dbg</a> &lt;&lt; <span class="stringliteral">"[IDT]: zoom["</span> &lt;&lt; zoom &lt;&lt; <span class="stringliteral">"] contains "</span>
00272                    &lt;&lt; m_zoomOffsets[zoom] &lt;&lt; <span class="stringliteral">"-"</span>
00273                    &lt;&lt; (m_zoomOffsets[zoom] + m_nbrItemsInZoom[zoom]) &lt;&lt; endl;
00274             dataPerZoom[zoom] = <span class="keyword">new</span> VALUE_TYPE[ nbrForCurZoom ];
00275             <span class="comment">// Reset to the default</span>
00276             <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> j = 0; j &lt; nbrForCurZoom; ++j ) {
00277                dataPerZoom[zoom][j] = m_defaultVal;
00278             }
00279             <span class="keywordflow">for</span>( <span class="keyword">typename</span> itemMap_t::const_iterator it = itemsToAdd.begin();
00280                  it != itemsToAdd.end();
00281                  ++it ) {
00282                <span class="keywordflow">if</span> ( <a class="code" href="classItemDataTable.html#h0">GET_ZOOM</a>( it-&gt;first ) != zoom ) <span class="keywordflow">continue</span>;
00283                <span class="keywordtype">int</span> pos = <a class="code" href="classItemDataTable.html#h1">GET_POS_IN_ZOOM</a>(it-&gt;first) - m_zoomOffsets[zoom];
00284                <span class="keywordflow">if</span> ( pos &lt; 0 || pos &gt;= m_nbrItemsInZoom[zoom] ) {
00285                   <span class="comment">// Outside - should be default</span>
00286                   <a class="code" href="config_8h.html#a29">MC2_ASSERT</a>( it-&gt;second == m_defaultVal );
00287                   <span class="keywordflow">continue</span>;
00288                }
00289                <span class="comment">// Fill in the ones inside - even if default.</span>
00290                dataPerZoom[zoom][pos] = it-&gt;second;
00291             }
00292          }
00293       }
00294       
00295       
00296       
00297       <a class="code" href="config_8h.html#a29">MC2_ASSERT</a>( curNbr == m_nbrItems );
00298       <a class="code" href="config_8h.html#a29">MC2_ASSERT</a>( is_sorted( items, items + m_nbrItems ) );
00299       
00300 <span class="preprocessor">#ifndef URIT_USES_ZOOM_LEVELS</span>
00301 <span class="preprocessor"></span>      <span class="comment">// Keep the table</span>
00302       m_items = items;
00303       m_itemDatas = tmpItemDatas;
00304       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; NUMBER_GFX_ZOOMLEVELS; ++i ) {
00305          <span class="keyword">delete</span> [] dataPerZoom[i];
00306       }
00307 <span class="preprocessor">#else</span>
00308 <span class="preprocessor"></span>      <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; NUMBER_GFX_ZOOMLEVELS; ++i ) {
00309          m_dataPerZoom[i] = dataPerZoom[i];
00310       }
00311       <span class="keyword">delete</span> [] items;
00312       <span class="keyword">delete</span> [] tmpItemDatas;
00313 <span class="preprocessor">#endif</span>
00314 <span class="preprocessor"></span>      
00315       <span class="comment">// Sanity check.</span>
00316       <span class="keywordflow">for</span> ( <span class="keyword">typename</span> itemMap_t::const_iterator it = itemsToAdd.begin();
00317             it != itemsToAdd.end();
00318             ++it ) {
00319          <a class="code" href="config_8h.html#a29">MC2_ASSERT</a>( it-&gt;second == getData( it-&gt;first ) );
00320       }
00321       <span class="keywordflow">return</span> m_nbrItems;
00322    }
00323 
<a name="l00325"></a><a class="code" href="classItemDataTable.html#a9">00325</a>    <span class="keywordtype">bool</span> <a class="code" href="classItemDataTable.html#a9">empty</a>()<span class="keyword"> const </span>{
00326       <span class="keywordflow">return</span> ! m_nbrItems;
00327    }
00328 
<a name="l00330"></a><a class="code" href="classItemDataTable.html#a10">00330</a>    <span class="keywordtype">void</span> <a class="code" href="classItemDataTable.html#a10">clear</a>() {
00331 <span class="preprocessor">#ifndef URIT_USES_ZOOM_LEVELS</span>
00332 <span class="preprocessor"></span>      <span class="keyword">delete</span> [] m_items;
00333       <span class="keyword">delete</span> [] m_itemDatas;
00334 <span class="preprocessor">#else</span>
00335 <span class="preprocessor"></span>      <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; NUMBER_GFX_ZOOMLEVELS; ++i ) {
00336          <span class="keyword">delete</span> [] m_dataPerZoom[i];
00337       }
00338 <span class="preprocessor">#endif</span>
00339 <span class="preprocessor"></span>      <a class="code" href="classItemDataTable.html#d0">init</a>();
00340    }
00341 
<a name="l00342"></a><a class="code" href="classItemDataTable.html#a11">00342</a>    <a class="code" href="Types_8h.html#a21">uint32</a> <a class="code" href="classItemDataTable.html#a11">getSizeInDataBuffer</a>()<span class="keyword"> const </span>{
00343       <a class="code" href="Types_8h.html#a21">uint32</a> size = 4 + 4 + 4;
00344       size += <a class="code" href="MapBits_8h.html#a0">NUMBER_GFX_ZOOMLEVELS</a> * 8;
00345       size += m_nbrItems * 4;
00346       size += VALUE_SAVER::getValSizeInDataBuffer( m_defaultVal );
00347       <a class="code" href="namespaceAlignUtility.html#a4">AlignUtility::alignLong</a>( size );
00348 <span class="preprocessor">#ifndef URIT_USES_ZOOM_LEVELS</span>
00349 <span class="preprocessor"></span>      <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; m_nbrItems; ++i ) {
00350          size += VALUE_SAVER::getValSizeInDataBuffer( m_itemDatas[i] );
00351       }
00352 <span class="preprocessor">#else</span>
00353 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00354 <span class="preprocessor"></span>      <a class="code" href="namespaceAlignUtility.html#a4">AlignUtility::alignLong</a>( size );
00355       <span class="keywordflow">return</span> size;
00356    }
00357    
<a name="l00359"></a><a class="code" href="classItemDataTable.html#a12">00359</a>    <span class="keywordtype">void</span> <a class="code" href="classItemDataTable.html#a12">save</a>( <a class="code" href="classDataBuffer.html">DataBuffer</a>&amp; buf )<span class="keyword"> const </span>{
00360       <a class="code" href="classDataBufferChecker.html">DataBufferChecker</a> dbc(buf, <span class="stringliteral">"ItemDataTable::save"</span>);
00361       buf.<a class="code" href="classDataBuffer.html#a13">writeNextLong</a>( <a class="code" href="classItemDataTable.html#a11">getSizeInDataBuffer</a>() );
00362       buf.<a class="code" href="classDataBuffer.html#a13">writeNextLong</a>( 0 ); <span class="comment">// Version</span>
00363       VALUE_SAVER::writeValue ( buf, m_defaultVal );
00364       buf.<a class="code" href="classDataBuffer.html#a32">alignToLongAndClear</a>();
00365       
00366       buf.<a class="code" href="classDataBuffer.html#a13">writeNextLong</a>( m_nbrItems );
00367       
00368       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; NUMBER_GFX_ZOOMLEVELS; ++i ) {
00369          buf.<a class="code" href="classDataBuffer.html#a13">writeNextLong</a>( m_nbrItemsInZoom[i] );
00370          buf.<a class="code" href="classDataBuffer.html#a13">writeNextLong</a>( m_zoomOffsets[i] );      
00371       }
00372 <span class="preprocessor">#ifndef URIT_USES_ZOOM_LEVELS</span>
00373 <span class="preprocessor"></span>      <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; m_nbrItems; ++i ) {
00374          buf.<a class="code" href="classDataBuffer.html#a13">writeNextLong</a>( m_items[i] );
00375       }
00376       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; m_nbrItems; ++i ) {
00377          VALUE_SAVER::writeValue( buf, m_itemDatas[i] );
00378       }
00379       buf.<a class="code" href="classDataBuffer.html#a32">alignToLongAndClear</a>();
00380 <span class="preprocessor">#else   </span>
00381 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00382 <span class="preprocessor"></span>      dbc.<a class="code" href="classDataBufferChecker.html#a2">assertPosition</a>( <a class="code" href="classItemDataTable.html#a11">getSizeInDataBuffer</a>() );
00383       <a class="code" href="MC2Logging_8h.html#a2">mc2dbg</a> &lt;&lt; <span class="stringliteral">"[IDT]: Saved "</span> &lt;&lt; endl;
00384    }
00385 
<a name="l00386"></a><a class="code" href="classItemDataTable.html#a13">00386</a>    <span class="keywordtype">void</span> <a class="code" href="classItemDataTable.html#a13">load</a>( <a class="code" href="classDataBuffer.html">DataBuffer</a>&amp; buf ) {
00387       <a class="code" href="classItemDataTable.html#a13">load</a>(buf, (VALUE_SAVER*)NULL );
00388    }
00389    
00391    <span class="keyword">template</span>&lt;<span class="keyword">class</span> VALUE_LOADER&gt;
<a name="l00392"></a><a class="code" href="classItemDataTable.html#a14">00392</a>    <span class="keywordtype">void</span> <a class="code" href="classItemDataTable.html#a13">load</a>( <a class="code" href="classDataBuffer.html">DataBuffer</a>&amp; buf, VALUE_LOADER* unused ) {
00393       <a class="code" href="classItemDataTable.html#a10">clear</a>();
00394       <a class="code" href="classDataBuffer.html">DataBuffer</a> readBuf( buf.<a class="code" href="classSharedBuffer.html#a29">getCurrentOffsetAddress</a>(),
00395                           buf.<a class="code" href="classSharedBuffer.html#a30">getNbrBytesLeft</a>() );
00396       <a class="code" href="Types_8h.html#a21">uint32</a> length = readBuf.readNextLong();
00397       readBuf.readNextLong(); <span class="comment">// Version - should be 0</span>
00398       VALUE_LOADER::readValue( readBuf, m_defaultVal );
00399       readBuf.alignToLong();
00400       
00401       readBuf.readNextLong( m_nbrItems );
00402       
00403       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; NUMBER_GFX_ZOOMLEVELS; ++i ) {
00404          readBuf.readNextLong( m_nbrItemsInZoom[i] );
00405          readBuf.readNextLong( m_zoomOffsets[i] );      
00406       }
00407 <span class="preprocessor">#ifndef URIT_USES_ZOOM_LEVELS</span>
00408 <span class="preprocessor"></span>      m_items = <span class="keyword">new</span> <a class="code" href="Types_8h.html#a21">uint32</a>[ m_nbrItems ];
00409       m_itemDatas = <span class="keyword">new</span> VALUE_TYPE[ m_nbrItems ];
00410       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; m_nbrItems; ++i ) {
00411          readBuf.readNextLong( m_items[i] );
00412       }
00413       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; m_nbrItems; ++i ) {
00414          VALUE_LOADER::readValue( readBuf, m_itemDatas[i] );
00415       }
00416       readBuf.alignToLong();
00417 <span class="preprocessor">#else   </span>
00418 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00419 <span class="preprocessor"></span>      <span class="comment">// Skip unknown data.</span>
00420       buf.<a class="code" href="classSharedBuffer.html#a32">readPastBytes</a>( length );
00421    }
00422   <span class="keyword">private</span>:
00423    
<a name="l00424"></a><a class="code" href="classItemDataTable.html#d0">00424</a>    <span class="keywordtype">void</span> <a class="code" href="classItemDataTable.html#d0">init</a>() {
00425 <span class="preprocessor">#ifndef URIT_USES_ZOOM_LEVELS</span>
00426 <span class="preprocessor"></span>      m_items     = NULL;
00427       m_itemDatas = NULL;
00428 <span class="preprocessor">#else</span>
00429 <span class="preprocessor"></span>      <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; NUMBER_GFX_ZOOMLEVELS; ++i ) {
00430          m_dataPerZoom[i] = NULL;
00431       }
00432 <span class="preprocessor">#endif</span>
00433 <span class="preprocessor"></span>      m_nbrItems  = 0;
00434       <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; NUMBER_GFX_ZOOMLEVELS; ++i ) {
00435          m_nbrItemsInZoom[i] = 0;
00436          m_zoomOffsets[i] = 0;
00437       }
00438    }
00439    
<a name="l00441"></a><a class="code" href="classItemDataTable.html#r0">00441</a>    <span class="keywordtype">int</span> m_nbrItemsInZoom[NUMBER_GFX_ZOOMLEVELS];
<a name="l00443"></a><a class="code" href="classItemDataTable.html#r1">00443</a>    <span class="keywordtype">int</span> m_zoomOffsets[NUMBER_GFX_ZOOMLEVELS];
<a name="l00445"></a><a class="code" href="classItemDataTable.html#r2">00445</a>    <span class="keywordtype">int</span> m_nbrItems;
00446 
00447 <span class="preprocessor">#ifndef URIT_USES_ZOOM_LEVELS</span>
00448 <span class="preprocessor"></span>
<a name="l00449"></a><a class="code" href="classItemDataTable.html#r3">00449</a>    <a class="code" href="Types_8h.html#a21">uint32</a>* m_items;
<a name="l00451"></a><a class="code" href="classItemDataTable.html#r4">00451</a>    VALUE_TYPE* m_itemDatas;
00452 <span class="preprocessor">#else</span>
00453 <span class="preprocessor"></span>
00454    VALUE_TYPE* m_dataPerZoom[NUMBER_GFX_ZOOMLEVELS];
00455 <span class="preprocessor">#endif</span>
00456 <span class="preprocessor"></span>
<a name="l00457"></a><a class="code" href="classItemDataTable.html#r5">00457</a>    VALUE_TYPE m_defaultVal;
00458 };
00459 
00460 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jun 30 10:11:47 2010 for mc2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
