<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mc2: SSLSocket.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000000.html">Shared</a>&nbsp;/&nbsp;<a class="el" href="dir_000051.html">Net</a>&nbsp;/&nbsp;<a class="el" href="dir_000052.html">include</a></div>
<h1>SSLSocket.h</h1><a href="SSLSocket_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 1999 - 2010, Vodafone Group Services Ltd</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
00008 <span class="comment">    * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
00009 <span class="comment">    * Neither the name of the Vodafone Group Services Ltd nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</span>
00010 <span class="comment"></span>
00011 <span class="comment">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00012 <span class="comment">*/</span>
00013 
00014 <span class="preprocessor">#ifndef SSLSOCKET_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#define SSLSOCKET_H</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#include "<a class="code" href="config_8h.html">config.h</a>"</span>
00018 <span class="preprocessor">#include "<a class="code" href="sockets_8h.html">sockets.h</a>"</span>
00019 <span class="preprocessor">#include "<a class="code" href="TCPSocket_8h.html">TCPSocket.h</a>"</span>
00020 <span class="preprocessor">#include "<a class="code" href="NotCopyable_8h.html">NotCopyable.h</a>"</span>
00021 
00022 <span class="preprocessor">#ifdef USE_SSL</span>
00023 <span class="preprocessor"></span><span class="comment">// This should be enough for openssl</span>
00024 <span class="preprocessor">#include &lt;openssl/ssl.h&gt;</span>
00025 <span class="comment">// some more functions, currently only used under solaris</span>
00026 <span class="preprocessor">#include &lt;openssl/rand.h&gt;</span>
00027 <span class="comment">// Reading pem formated certificates and keys</span>
00028 <span class="preprocessor">#include &lt;openssl/pem.h&gt;</span>
00029 <span class="comment">// Error printing</span>
00030 <span class="preprocessor">#include &lt;openssl/err.h&gt;</span>
00031 <span class="comment">// Compression</span>
00032 <span class="preprocessor">#include &lt;openssl/comp.h&gt;</span>
00033 <span class="comment">// CLient side session caching</span>
00034 <span class="preprocessor">#include "<a class="code" href="BinarySearchTree_8h.html">BinarySearchTree.h</a>"</span>
00035 
00036 
00042 <span class="keyword">class </span>SSL_CONTEXT: <span class="keyword">private</span> <a class="code" href="classNotCopyable.html">NotCopyable</a> {
00043    <span class="keyword">public</span>:
00048       SSL_CONTEXT( SSL_CTX* ctx );
00049 
00050 
00054       ~SSL_CONTEXT();
00055 
00059       <span class="keywordtype">void</span> exitCleanup();
00060 
00064       <span class="keyword">inline</span> <span class="keywordtype">void</span> setClientConnections( 
00065          <a class="code" href="classBinarySearchTree.html">BinarySearchTree</a>* clientConnections );
00066       
00067       
00071       <span class="keyword">inline</span> <a class="code" href="classBinarySearchTree.html">BinarySearchTree</a>* getClientConnections();
00072 
00073 
00077       <span class="keyword">inline</span> SSL_CTX* getCTX();
00078 
00079 
00080    <span class="keyword">private</span>:
00084       SSL_CTX* m_ctx;
00085 
00086 
00090       <a class="code" href="classBinarySearchTree.html">BinarySearchTree</a>* m_clientConnections;
00091 };
00092 
00096 <span class="keyword">class </span>SSLCleaner {
00097 <span class="keyword">public</span>:
00098    SSLCleaner();
00099    ~SSLCleaner();
00100 };
00101 
00112 <span class="keyword">class </span>SSLSocket : <span class="keyword">public</span> <a class="code" href="classTCPSocket.html">TCPSocket</a> {
00113    <span class="keyword">public</span>:
00119       <span class="keyword">enum</span> ssl_socket_t {
00121          SSL_SOCKET_CLIENTS,
00123          SSL_SOCKET_CLIENTS_TLSv1,
00125          SSL_SOCKET_SERVERS,
00127          SSL_SOCKET_SERVERS_TLSv1,
00129          SSL_SOCKET_CLIENTS_AND_SERVERS,
00131          SSL_SOCKET_CLIENTS_AND_SERVERS_TLSv1
00132       };
00133 
00134 
00163       <span class="keyword">static</span> SSL_CONTEXT* makeNewCTX( 
00164          ssl_socket_t ssl_type,
00165          <span class="keyword">const</span> <span class="keywordtype">char</span>* defaultCertDir,
00166          <span class="keyword">const</span> <span class="keywordtype">char</span>* ssl_public_cert_file_name,
00167          <span class="keyword">const</span> <span class="keywordtype">char</span>* ssl_private_cert_file_name,
00168          <span class="keyword">const</span> <span class="keywordtype">char</span>* ssl_private_key_file_name,
00169          <span class="keyword">const</span> <span class="keywordtype">char</span>* ssl_cipher_list,
00170          <span class="keywordtype">bool</span> compress = <span class="keyword">false</span>,
00171          <span class="keywordtype">bool</span> bugs = <span class="keyword">true</span> );
00172 
00173 
00178       <span class="keyword">static</span> <span class="keywordtype">void</span> freeCTX( SSL_CTX* ctx );
00179       
00180 
00185       SSLSocket( SSL_CONTEXT* ctx );
00186 
00187 
00197       SSLSocket( SOCKET sock, SSL* ssl, SSL_CONTEXT* ctx );
00198 
00199 
00203       <span class="keyword">virtual</span> ~SSLSocket();
00204 
00205 
00209       <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classTCPSocket.html#a6">close</a>();
00210 
00211 
00217       <span class="keywordtype">void</span> nonWriteClose();
00218 
00219 
00231       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a9">connect</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> *hostname, <span class="keywordtype">int</span> portnumber );
00232 
00233       
00243       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a9">connect</a>( uint32 hostip, uint16 hostport );
00244 
00245 
00259       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a9">connect</a>( <span class="keyword">const</span> <span class="keywordtype">char</span> *hostname, <span class="keywordtype">int</span> portnumber, 
00260                             uint32 timeout_us );
00261 
00262 
00272       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a9">connect</a>( <span class="keyword">const</span> <a class="code" href="classIPnPort.html">IPnPort</a>&amp; addr, uint32 timeout_us );
00273 
00274 
00282       <span class="keywordtype">bool</span> sslConnect( uint32 timeout_us );
00283       
00284       
00291       <span class="keyword">virtual</span> <a class="code" href="classTCPSocket.html">TCPSocket</a>* <a class="code" href="classTCPSocket.html#a23">accept</a>();
00292 
00293       
00304       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#a34">initialHandshake</a>( 
00305          <span class="keywordtype">long</span> micros = TCPSOCKET_INFINITE_TIMEOUT );
00306 
00307 
00315       <span class="keyword">virtual</span> <span class="keywordtype">int</span> <a class="code" href="classTCPSocket.html#a35">initialHandshaking</a>();
00316 
00317 
00326       <span class="keywordtype">void</span> setCertificateAndKey( <span class="keyword">const</span> <span class="keywordtype">char</span>* certificateFile,
00327                                  <span class="keyword">const</span> <span class="keywordtype">char</span>* keyFile );
00328 
00329    <span class="keyword">protected</span>:
00340       <span class="keyword">virtual</span> ssize_t <a class="code" href="classTCPSocket.html#b1">protectedRead</a>( byte* buffer,
00341                                      size_t size );
00342       
00343       
00354       <span class="keyword">virtual</span> ssize_t <a class="code" href="classTCPSocket.html#b2">protectedWrite</a>( <span class="keyword">const</span> byte* buffer,
00355                                       size_t size );
00356 
00357 
00368       <span class="keyword">virtual</span> <span class="keywordtype">bool</span> <a class="code" href="classTCPSocket.html#b3">checkForCachedData</a>( byte* buffer, size_t size );
00369 
00370    <span class="keyword">protected</span>:
00374       SSL_CONTEXT* m_ctx;
00375 
00376 
00377    <span class="keyword">private</span>:
00382       <span class="keywordtype">void</span> <a class="code" href="classTCPSocket.html#d0">init</a>( SSL_CONTEXT* ctx );
00383 
00384       
00388       SSL* m_ssl;
00389 
00390 
00395       <span class="keyword">class </span>clientHostSession : <span class="keyword">public</span> <a class="code" href="classBinarySearchTreeNode.html">BinarySearchTreeNode</a> {
00396          <span class="keyword">public</span>:
00404             clientHostSession( uint32 <a class="code" href="classIP.html">IP</a>, uint16 port, 
00405                                <span class="keyword">const</span> SSL_SESSION* <span class="keyword">const</span> session );
00406 
00407             
00411             ~clientHostSession();
00412 
00413 
00419 
00420                <span class="keyword">virtual</span> <span class="keywordtype">bool</span>
00421                   <a class="code" href="namespaceSTLUtility.html#a34">operator &gt;  </a>(<span class="keyword">const</span> <a class="code" href="classBinarySearchTreeNode.html">BinarySearchTreeNode</a> &amp;node) <span class="keyword">const</span>;
00422 
00424                <span class="keyword">virtual</span> <span class="keywordtype">bool</span>
00425                   <a class="code" href="namespaceSTLUtility.html#a32">operator &lt;  </a>(<span class="keyword">const</span> <a class="code" href="classBinarySearchTreeNode.html">BinarySearchTreeNode</a> &amp;node) <span class="keyword">const</span>;
00426 
00428                <span class="keyword">virtual</span> <span class="keywordtype">bool</span>
00429                   <a class="code" href="namespaceSTLUtility.html#a31">operator == </a>(<span class="keyword">const</span> <a class="code" href="classBinarySearchTreeNode.html">BinarySearchTreeNode</a> &amp;node) <span class="keyword">const</span>;
00431 
00432 
00436             <span class="keyword">inline</span> <span class="keyword">const</span> SSL_SESSION* <span class="keyword">const</span> getSession();
00437 
00438 
00442             <span class="keywordtype">void</span> setSession( <span class="keyword">const</span> SSL_SESSION* <span class="keyword">const</span> session );
00443 
00444 
00445          <span class="keyword">private</span>:
00449             <a class="code" href="Types_8h.html#a21">uint32</a> m_IP;
00450 
00451             
00455             <a class="code" href="Types_8h.html#a19">uint16</a> m_port;
00456 
00457             
00461             <span class="keyword">const</span> SSL_SESSION* m_session;
00462       };
00463 
00468       <span class="keyword">static</span> RSA* tmpRSA512;
00469 
00470 
00475       <span class="keyword">static</span> RSA* tmpRSA1024;
00476 
00477 
00482       <span class="keyword">static</span> RSA* getTmpRSACallback( SSL* ssl, 
00483                                      <span class="keywordtype">int</span> nExport, 
00484                                      <span class="keywordtype">int</span> nKeyLength );
00485 
00486 
00490       <a class="code" href="classMC2String.html">MC2String</a> m_certificateFile;
00491 
00492 
00496       <a class="code" href="classMC2String.html">MC2String</a> m_keyFile;
00497 };
00498 
00499 
00500 <span class="comment">// ========================================================================</span>
00501 <span class="comment">//                                  Implementation of the inlined methods =</span>
00502 
00503 
00504 <span class="keyword">const</span> SSL_SESSION* <span class="keyword">const</span> 
00505 SSLSocket::clientHostSession::getSession() {
00506    <span class="keywordflow">return</span> m_session;
00507 }
00508 
00509 
00510 <span class="keywordtype">void</span>
00511 SSL_CONTEXT::setClientConnections( <a class="code" href="classBinarySearchTree.html">BinarySearchTree</a>* clientConnections ) {
00512    <span class="keyword">delete</span> m_clientConnections;
00513    m_clientConnections = clientConnections;
00514 }
00515 
00516 
00517 <a class="code" href="classBinarySearchTree.html">BinarySearchTree</a>* 
00518 SSL_CONTEXT::getClientConnections() {
00519    <span class="keywordflow">return</span> m_clientConnections;
00520 }
00521 
00522 
00523 SSL_CTX* 
00524 SSL_CONTEXT::getCTX() {
00525    <span class="keywordflow">return</span> m_ctx;
00526 }
00527 
00528 
00529 <span class="preprocessor">#endif // USE_SSL</span>
00530 <span class="preprocessor"></span>
00531 <span class="preprocessor">#endif // SSLSOCKET_H</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jun 30 10:11:50 2010 for mc2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
