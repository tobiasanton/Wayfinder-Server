<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>mc2: OldMapFilter.h Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.9.1 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="dirs.html">Directories</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="namespacemembers.html">Namespace&nbsp;Members</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="globals.html">File&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<div class="nav">
<a class="el" href="dir_000002.html">Server</a>&nbsp;/&nbsp;<a class="el" href="dir_000007.html">MapGen</a>&nbsp;/&nbsp;<a class="el" href="dir_000034.html">include</a></div>
<h1>OldMapFilter.h</h1><a href="OldMapFilter_8h.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment">00001 <span class="comment">/*</span>
00002 <span class="comment">Copyright (c) 1999 - 2010, Vodafone Group Services Ltd</span>
00003 <span class="comment">All rights reserved.</span>
00004 <span class="comment"></span>
00005 <span class="comment">Redistribution and use in source and binary forms, with or without modification, are permitted provided that the following conditions are met:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    * Redistributions of source code must retain the above copyright notice, this list of conditions and the following disclaimer.</span>
00008 <span class="comment">    * Redistributions in binary form must reproduce the above copyright notice, this list of conditions and the following disclaimer in the documentation and/or other materials provided with the distribution.</span>
00009 <span class="comment">    * Neither the name of the Vodafone Group Services Ltd nor the names of its contributors may be used to endorse or promote products derived from this software without specific prior written permission.</span>
00010 <span class="comment"></span>
00011 <span class="comment">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
00012 <span class="comment">*/</span>
00013 
00014 <span class="preprocessor">#ifndef OLDMAPFILTER_H</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#define OLDMAPFILTER_H</span>
00016 <span class="preprocessor"></span>
00017 <span class="preprocessor">#include "<a class="code" href="config_8h.html">config.h</a>"</span>
00018 
00019 <span class="preprocessor">#include "<a class="code" href="ItemTypes_8h.html">ItemTypes.h</a>"</span>
00020 <span class="preprocessor">#include &lt;set&gt;</span>
00021 <span class="preprocessor">#include &lt;map&gt;</span>
00022 <span class="preprocessor">#include &lt;vector&gt;</span>
00023 <span class="preprocessor">#include &lt;list&gt;</span>
00024 <span class="preprocessor">#include "<a class="code" href="MC2Coordinate_8h.html">MC2Coordinate.h</a>"</span>
00025 <span class="preprocessor">#include "<a class="code" href="IDPairVector_8h.html">IDPairVector.h</a>"</span>
00026 <span class="preprocessor">#include "<a class="code" href="Stack_8h.html">Stack.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="GfxData_8h.html">GfxData.h</a>"</span>
00028 <span class="preprocessor">#include "<a class="code" href="GfxFilterUtil_8h.html">GfxFilterUtil.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="OldGenericMap_8h.html">OldGenericMap.h</a>"</span>
00030 <span class="preprocessor">#include "<a class="code" href="GMSGfxData_8h.html">GMSGfxData.h</a>"</span>
00031 
<a name="l00035"></a><a class="code" href="classOldMapFilter.html">00035</a> <span class="keyword">class </span><a class="code" href="classOldMapFilter.html">OldMapFilter</a> {
00036 
00037    <span class="keyword">public</span>:
00038 
00039       <a class="code" href="classOldMapFilter.html">OldMapFilter</a>();
00040       <span class="keyword">virtual</span> ~<a class="code" href="classOldMapFilter.html">OldMapFilter</a>();
00041 
00074       <span class="keywordtype">void</span> filter( 
00075             <a class="code" href="classOldGenericMap.html">OldGenericMap</a>* mapToFilter,
00076             <span class="keyword">const</span> set&lt;OldGenericMap*&gt;&amp; mapsToConsider,
00077             <span class="keyword">const</span> set&lt;ItemTypes::itemType&gt;&amp; itemTypes,
00078             <span class="keywordtype">bool</span>  useGfxData,
00079                   <a class="code" href="classvector.html">vector&lt;int&gt;</a> filterMaxDists );
00080 
00091       <span class="keywordtype">void</span> filterCountryPolygon(
00092             <a class="code" href="classOldGenericMap.html">OldGenericMap</a>* mapToFilter, <a class="code" href="classvector.html">vector&lt;int&gt;</a> filterMaxDists,
00093             set&lt;MC2Coordinate&gt; breakPoints );
00094 
00096       <span class="keyword">inline</span> <span class="keywordtype">int</span> getFiltDistanceForMapGfx( <a class="code" href="Types_8h.html#a21">uint32</a> level );
00097 
00098       <span class="comment">/*</span>
00099 <span class="comment">       * Get map gfx data filter high level distance for a certain </span>
00100 <span class="comment">       * filter level (1-15).</span>
00101 <span class="comment">       *</span>
00102 <span class="comment">       */</span>
00103       <span class="keyword">inline</span> <span class="keywordtype">int</span> getFiltHighLevelDistanceForMapGfx( <a class="code" href="Types_8h.html#a21">uint32</a> level );
00104 
00113       <span class="keyword">inline</span> <span class="keywordtype">int</span> getFiltDistanceForAreaItem(
00114                   <a class="code" href="Types_8h.html#a21">uint32</a> level, <span class="keywordtype">int</span> minAreaFilterDistance = -1 );
00115 
00124       <span class="keyword">inline</span> <span class="keywordtype">int</span> getFiltDistanceForLineItem(
00125                   <a class="code" href="Types_8h.html#a21">uint32</a> level, <span class="keywordtype">int</span> minLineFilterDistance = -1 );
00126 
00148       <span class="keyword">static</span> <span class="keywordtype">void</span> printCountryBorderToFile(
00149          <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a> firstBreakPoint, <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a> lastBreakPoint,
00150          <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a> onTheWayPoint,
00151          <span class="keyword">const</span> <span class="keywordtype">char</span>* countryMapName, <a class="code" href="classGfxData.html">GfxData</a>* printGfx, <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a> poly,
00152          <span class="keywordtype">int</span> startSplitIdx, <span class="keywordtype">int</span> nbrCoordsInBorderPart);
00153 
00190       <span class="keyword">static</span> <span class="keywordtype">bool</span> oldBorderFiltering(
00191             <a class="code" href="classGfxData.html">GfxData</a>* gfxPartToFilter, <span class="keyword">const</span> <span class="keywordtype">char</span>* countryMapName,
00192             <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a> firstBreakPoint, <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a> lastBreakPoint,
00193             <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a> onTheWayPoint,
00194             <span class="keywordtype">bool</span> gfxPartForward,
00195             <a class="code" href="classGfxDataFull.html">GfxDataFull</a>* outGfx, <a class="code" href="Types_8h.html#a21">uint32</a> polyNbr );
00196 
00209       <span class="keyword">static</span> <span class="keywordtype">bool</span> coordCloseToBorderPart( <span class="keyword">const</span> <a class="code" href="classGfxData.html">GfxData</a>* borderPart,
00210                                           <span class="keyword">const</span> <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a> <a class="code" href="RouteRequestData_8h.html#a3a0">coord</a>,
00211                                           <a class="code" href="Types_8h.html#a27">float64</a>&amp; sqDist );
00212 
<a name="l00222"></a><a class="code" href="classOldMapFilter.html#z241_0">00222</a>          <span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a> nrOflsbsToBeUsed;
00223 
<a name="l00228"></a><a class="code" href="classOldMapFilter.html#z241_1">00228</a>          <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> coordBlankMask;
00230 
00231    <span class="keyword">private</span>:
<a name="l00239"></a><a class="code" href="classOldMapFilter.html#y0">00239</a>       <span class="keyword">typedef</span> <a class="code" href="classmap.html">map&lt;MC2Coordinate, set&lt;IDPair_t&gt;</a> &gt; <a class="code" href="classmap.html">coordMap_t</a>;
00240 
<a name="l00250"></a><a class="code" href="classOldMapFilter.html#z242_0">00250</a>          <a class="code" href="classvector.html">vector&lt;int&gt;</a> m_mapGfxFilterDistances;
00251 
<a name="l00256"></a><a class="code" href="classOldMapFilter.html#z242_1">00256</a>          <a class="code" href="classvector.html">vector&lt;int&gt;</a> m_mapGfxFilterHighLevelDistances;
00257 
00258          <span class="comment">/*</span>
00259 <span class="comment">          * Tells if the vector with map gfx data filter low level </span>
00260 <span class="comment">          * dists is initialised.</span>
00261 <span class="comment">          */</span>
<a name="l00262"></a><a class="code" href="classOldMapFilter.html#z242_2">00262</a>          <span class="keywordtype">bool</span> m_mapGfxDistDefined;
00263 
00264          <span class="comment">/*</span>
00265 <span class="comment">          * Tells if the vector with map gfx data filter high level           </span>
00266 <span class="comment">          * dists is initialised.</span>
00267 <span class="comment">          */</span>
<a name="l00268"></a><a class="code" href="classOldMapFilter.html#z242_3">00268</a>          <span class="keywordtype">bool</span> m_mapGfxHighLevelDistDefined;
00269 
<a name="l00274"></a><a class="code" href="classOldMapFilter.html#z242_4">00274</a>          <a class="code" href="classvector.html">vector&lt;int&gt;</a> m_areaItemFilterDistances;
00275 
<a name="l00277"></a><a class="code" href="classOldMapFilter.html#z242_5">00277</a>          <span class="keywordtype">bool</span> m_areaItemDistDefined;
00278 
<a name="l00283"></a><a class="code" href="classOldMapFilter.html#z242_6">00283</a>          <a class="code" href="classvector.html">vector&lt;int&gt;</a> m_lineItemFilterDistances;
00284 
<a name="l00286"></a><a class="code" href="classOldMapFilter.html#z242_7">00286</a>          <span class="keywordtype">bool</span> m_lineItemDistDefined;
00288 
00293       <span class="keyword">inline</span> <span class="keywordtype">void</span> initMapGfxDistances();
00294      
00299       <span class="keyword">inline</span> <span class="keywordtype">void</span> initMapGfxHighLevelDistances();
00300        
00308       <span class="keyword">inline</span> <span class="keywordtype">void</span> initAreaItemDistances( <span class="keywordtype">int</span> minAreaFilterDistance = -1 );
00309       
00317       <span class="keyword">inline</span> <span class="keywordtype">void</span> initLineItemDistances( <span class="keywordtype">int</span> minLineFilterDistance = -1 );
00318       
00329       <span class="keywordtype">void</span> updateCoordIntersectionMap( 
00330                   <a class="code" href="classOldGenericMap.html">OldGenericMap</a>* theMap,
00331             <span class="keyword">const</span> set&lt;ItemTypes::itemType&gt;&amp; itemTypes,
00332             <span class="keywordtype">bool</span>  useGfxData,
00333                   coordMap_t&amp; coordIntersectMap );
00334 
00342       <span class="keywordtype">void</span> updateCoordIntersectionMapForMapGfx(
00343                <a class="code" href="classOldGenericMap.html">OldGenericMap</a>* theMap,
00344                coordMap_t&amp; coordIntersectMap );
00345 
00358       <span class="keywordtype">void</span> filterUsingInfoInCoordsIntersectionMap( 
00359                   <a class="code" href="classOldGenericMap.html">OldGenericMap</a>* theMap,
00360             <span class="keyword">const</span> set&lt;ItemTypes::itemType&gt;&amp; itemTypes,
00361             <span class="keywordtype">bool</span>  useGfxData,
00362                   coordMap_t&amp; coordIntersectMap,
00363                   <a class="code" href="classvector.html">vector&lt;int&gt;</a> filterMaxDists );
00364 
00380       <span class="keywordtype">void</span> filterOneGfxUsingInfoInCoordsIntersectionMap( 
00381                   <a class="code" href="classOldGenericMap.html">OldGenericMap</a>* theMap,  <span class="comment">// param not really needed</span>
00382                   <span class="keyword">const</span> <a class="code" href="classGfxData.html">GfxData</a>* gfx,
00383                   <a class="code" href="classGfxDataFull.html">GfxDataFull</a>* newGfx,
00384                   <span class="keywordtype">bool</span> useGfxData,
00385                   coordMap_t&amp; coordIntersectMap,
00386                   <a class="code" href="classvector.html">vector&lt;int&gt;</a> filterMaxDists,
00387                   <span class="keywordtype">bool</span> countryBorder,
00388                   <span class="keywordtype">bool</span> dumpFilterInfo = <span class="keyword">false</span> );
00389 
00412       <span class="keyword">template</span>&lt;<span class="keyword">class</span> XYHELPER&gt;
00413          <span class="keyword">inline</span> <span class="keywordtype">void</span> filterSegment(
00414                      <a class="code" href="classOldGenericMap.html">OldGenericMap</a>* mapToFilter,
00415                <span class="keyword">const</span> XYHELPER&amp; xyHelper, 
00416                <span class="keyword">const</span> uint32 opfBegin,
00417                <span class="keyword">const</span> uint32 opfEnd,
00418                <span class="keyword">const</span> <a class="code" href="classvector.html">vector&lt;int&gt;</a> filterMaxDists,
00419                <span class="keyword">const</span> uint32 p,
00420                <span class="keyword">const</span> <a class="code" href="classGfxData.html">GfxData</a>* gfx,
00421                      <a class="code" href="classGfxDataFull.html">GfxDataFull</a>* outGfx,
00422                      <span class="keywordtype">bool</span> countryBorder,
00423                      <span class="keywordtype">bool</span> breakPoints,
00424                      <span class="keywordtype">bool</span> dumpFilterInfo = <span class="keyword">false</span> );
00425 
00430       <span class="keyword">inline</span> <span class="keywordtype">void</span> dumpPaths( <span class="keywordtype">int</span>** paths, <span class="keywordtype">int</span> rows, <span class="keywordtype">int</span> cols ) <span class="keyword">const</span>;
00431 
00437       <span class="keywordtype">bool</span> validFilterLevelDistances( <a class="code" href="classvector.html">vector&lt;int&gt;</a> filterMaxDists );
00438 
00449       <span class="keyword">static</span> <span class="keywordtype">void</span> printBorderItemToFile( uint32 borderId,
00450          <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a>&amp; firstCoord, <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a>&amp; lastCoord,
00451          <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a>&amp; middleCoord );
00452 
00453 };
00454 
00455 <span class="comment">// (((=====================================================================</span>
00456 <span class="comment">//                                      Implementation of inlined methods =</span>
00457 
00458 <span class="keyword">template</span>&lt;<span class="keyword">class</span> XYHELPER&gt; 
<a name="l00459"></a><a class="code" href="classOldMapFilter.html#d8">00459</a> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classOldMapFilter.html#d8">OldMapFilter::filterSegment</a>(
00460             <a class="code" href="classOldGenericMap.html">OldGenericMap</a>* mapToFilter,
00461       <span class="keyword">const</span> XYHELPER&amp; xyHelper,
00462       <span class="keyword">const</span> uint32 opfBegin,
00463       <span class="keyword">const</span> uint32 opfEnd,
00464       <span class="keyword">const</span> <a class="code" href="classvector.html">vector&lt;int&gt;</a> filterMaxDists,
00465       <span class="keyword">const</span> uint32 p,
00466       <span class="keyword">const</span> <a class="code" href="classGfxData.html">GfxData</a>* gfx,
00467             <a class="code" href="classGfxDataFull.html">GfxDataFull</a>* outGfx,
00468             <span class="keywordtype">bool</span> countryBorder,
00469             <span class="keywordtype">bool</span> breakPoints,
00470             <span class="keywordtype">bool</span> dumpFilterInfo ) {
00471    
00472    <span class="comment">// Why is this function templated?</span>
00473  
00474    <span class="keyword">const</span> <span class="keywordtype">char</span>* countryMapName = mapToFilter-&gt;<a class="code" href="classOldGenericMapHeader.html#a6">getMapName</a>();
00475 
00476    <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a> nbrCoordsInGfxPoly = gfx-&gt;<a class="code" href="classGfxData.html#a9">getNbrCoordinates</a>(p);
00477    <span class="comment">// Get size of the polygon part to filter, from opfBegin to opfEnd.</span>
00478    <span class="comment">// Note that opfBegin might be larger than (or equal to) opfEnd </span>
00479    <span class="comment">// if filtering a a shared polygon part that extends over the coord 0.</span>
00480    <span class="keywordtype">int</span> tmpFiltSize = opfEnd - opfBegin;
00481    <span class="keywordflow">if</span> ( tmpFiltSize &lt;= 0 ) {
00482       tmpFiltSize = nbrCoordsInGfxPoly + opfEnd - opfBegin;
00483    }
00484    <span class="keyword">const</span> <span class="keywordtype">int</span> filtSize = tmpFiltSize;
00485    
00486    <span class="keyword">const</span> <span class="keywordtype">int</span> setLevelMask = 0xffffffff - <a class="code" href="classOldMapFilter.html#z241_1">coordBlankMask</a> + 1;
00487 
00488    <span class="keywordflow">if</span> ( dumpFilterInfo ) {
00489       cout &lt;&lt; <span class="stringliteral">" filter poly="</span> &lt;&lt; p &lt;&lt; <span class="stringliteral">" opfBegin="</span> &lt;&lt; opfBegin &lt;&lt; <span class="stringliteral">" opfEnd="</span>
00490            &lt;&lt; opfEnd &lt;&lt; <span class="stringliteral">" ("</span> &lt;&lt; nbrCoordsInGfxPoly &lt;&lt; <span class="stringliteral">")"</span> &lt;&lt; endl;
00491    }
00492    <span class="comment">// If trying to filter just one coordinate,</span>
00493    <span class="comment">// don't filter if the coord is part of a polygon with more coords since</span>
00494    <span class="comment">// the coord will come back in next segment and be filtered then.</span>
00495    <span class="comment">// If just one coord in the polygon, set filter level to max.</span>
00496    <span class="keywordflow">if</span> ( filtSize == 1 ) {
00497       <span class="keywordflow">if</span> ( ( outGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_7">getNbrCoordinates</a>(p) == 0 ) &amp;&amp;
00498            ( nbrCoordsInGfxPoly == 1 ) ) {
00499       
00500          <a class="code" href="Types_8h.html#a21">uint32</a> filterLatValue = filterMaxDists.size() / setLevelMask;
00501          <a class="code" href="Types_8h.html#a21">uint32</a> filterLonValue = filterMaxDists.size() % setLevelMask;
00502       
00503          outGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_29">addCoordinate</a>(
00504                (gfx-&gt;<a class="code" href="classGfxData.html#a6">getLat</a>( p, opfBegin ) &amp; coordBlankMask) + filterLatValue,
00505                (gfx-&gt;<a class="code" href="classGfxData.html#a7">getLon</a>( p, opfBegin ) &amp; coordBlankMask) + filterLonValue );
00506          <span class="keywordflow">if</span> ( dumpFilterInfo )
00507             cout &lt;&lt; <span class="stringliteral">" Not filtering 1 coord, but adding to outGfx "</span>
00508                  &lt;&lt; p &lt;&lt; <span class="stringliteral">":"</span> &lt;&lt; opfBegin &lt;&lt; endl;
00509       }
00510       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( dumpFilterInfo ) {
00511          cout &lt;&lt; <span class="stringliteral">" Not filtering 1 coord, not adding to outGfx "</span>
00512               &lt;&lt; p &lt;&lt; <span class="stringliteral">":"</span> &lt;&lt; opfBegin &lt;&lt; endl;
00513       }
00514       <span class="keywordflow">return</span>;
00515    }
00516    <a class="code" href="config_8h.html#a5">DEBUG8</a>(
00517    <span class="keywordflow">if</span> ( countryBorder &amp;&amp; ((p == 0) || (p == 1)) ) {
00518       <a class="code" href="MC2Logging_8h.html#a2">mc2dbg</a> &lt;&lt; <span class="stringliteral">"   filter "</span> &lt;&lt; opfBegin &lt;&lt; <span class="stringliteral">"-&gt;"</span> &lt;&lt; opfEnd 
00519              &lt;&lt; <span class="stringliteral">" size="</span> &lt;&lt; filtSize &lt;&lt; endl;
00520    });
00521    
00522    <span class="comment">// Decide if to filter from opfBegin (forwards) or from opfEnd-1 (backwards)</span>
00523    <span class="comment">// always filter from lowest lat/lowest lon to make shared polygon parts</span>
00524    <span class="comment">// be filtered in the same direction</span>
00525    <span class="keywordtype">bool</span> filterForwards = <span class="keyword">false</span>;
00526    <a class="code" href="Types_8h.html#a21">uint32</a> endSplitIdx = opfEnd-1;
00527    <span class="keywordflow">if</span> ( endSplitIdx &lt; 0 ) {
00528       endSplitIdx = nbrCoordsInGfxPoly - 1;
00529    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( endSplitIdx &gt;= nbrCoordsInGfxPoly ) {
00530       endSplitIdx = endSplitIdx - nbrCoordsInGfxPoly;
00531    }
00532    <span class="keywordflow">if</span> ( gfx-&gt;<a class="code" href="classGfxData.html#a6">getLat</a>(p, opfBegin) &lt; gfx-&gt;<a class="code" href="classGfxData.html#a6">getLat</a>(p, endSplitIdx) ) {
00533       filterForwards = <span class="keyword">true</span>;
00534    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( gfx-&gt;<a class="code" href="classGfxData.html#a6">getLat</a>(p, opfBegin) &gt; gfx-&gt;<a class="code" href="classGfxData.html#a6">getLat</a>(p, endSplitIdx) ) {
00535       filterForwards = <span class="keyword">false</span>;
00536    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( gfx-&gt;<a class="code" href="classGfxData.html#a7">getLon</a>(p, opfBegin) &lt; gfx-&gt;<a class="code" href="classGfxData.html#a7">getLon</a>(p, endSplitIdx) ) {
00537       filterForwards = <span class="keyword">true</span>;
00538    }
00539    <span class="comment">// debugprint</span>
00540    <span class="keywordflow">if</span> ( countryBorder &amp;&amp; breakPoints <span class="comment">/*&amp; ((p == 0) || (p == 1))*/</span> ) {
00541       <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a> from( gfx-&gt;<a class="code" href="classGfxData.html#a6">getLat</a>(p, opfBegin), gfx-&gt;<a class="code" href="classGfxData.html#a7">getLon</a>(p, opfBegin) );
00542       <a class="code" href="Types_8h.html#a21">uint32</a> toIdx = ( (opfBegin+filtSize-1) % nbrCoordsInGfxPoly );
00543       <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a> to( gfx-&gt;<a class="code" href="classGfxData.html#a6">getLat</a>(p, toIdx), gfx-&gt;<a class="code" href="classGfxData.html#a7">getLon</a>(p, toIdx) );
00544       <a class="code" href="MC2Logging_8h.html#a3">mc2dbg1</a> &lt;&lt; <span class="stringliteral">"Filter country borderPart poly="</span> &lt;&lt; p 
00545            &lt;&lt; <span class="stringliteral">" forwards="</span> &lt;&lt; int(filterForwards)
00546            &lt;&lt; <span class="stringliteral">" f="</span> &lt;&lt; opfBegin &lt;&lt; <span class="stringliteral">"-&gt;"</span> &lt;&lt; toIdx &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; from &lt;&lt; <span class="stringliteral">"-&gt;"</span> &lt;&lt; to
00547            &lt;&lt; <span class="stringliteral">" b="</span> &lt;&lt; toIdx &lt;&lt; <span class="stringliteral">"-&gt;"</span> &lt;&lt; opfBegin
00548            &lt;&lt; endl;
00549    }
00550    
00551    <span class="comment">// Fill the tempPoly with the original values to init it.</span>
00552    <a class="code" href="classGfxDataFull.html">GfxDataFull</a>* tempPolyGfx = <a class="code" href="classGMSGfxData.html#e1">GMSGfxData::createNewGfxData</a>( static_cast&lt;OldGenericMap* &gt;( NULL ), <span class="keyword">true</span> );
00553    <span class="keywordflow">if</span> ( filterForwards ) {
00554       <span class="keywordflow">for</span>( <span class="keywordtype">int</span> l = 0; l &lt; filtSize; l++ ) {
00555          <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a> c = ( (l + opfBegin) % nbrCoordsInGfxPoly );
00556          tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_29">addCoordinate</a>(
00557                ( gfx-&gt;<a class="code" href="classGfxData.html#a6">getLat</a>( p, c ) &amp; coordBlankMask ),
00558                ( gfx-&gt;<a class="code" href="classGfxData.html#a7">getLon</a>( p, c ) &amp; coordBlankMask ),
00559                false );
00560       }
00561    } <span class="keywordflow">else</span> {
00562       <span class="keywordflow">for</span>( <span class="keywordtype">int</span> l = filtSize-1; l &gt;= 0; l-- ) {
00563          <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a> c = ( (l + opfBegin) % nbrCoordsInGfxPoly );
00564          tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_29">addCoordinate</a>(
00565                ( gfx-&gt;<a class="code" href="classGfxData.html#a6">getLat</a>( p, c ) &amp; coordBlankMask ),
00566                ( gfx-&gt;<a class="code" href="classGfxData.html#a7">getLon</a>( p, c ) &amp; coordBlankMask ),
00567                false );
00568       }
00569    }
00570 
00571    <span class="comment">// If filtering country polygons, check if this border was filtered once</span>
00572    <span class="comment">// before from another country. If so, then don't filter again, but copy</span>
00573    <span class="comment">// the already filtered border to avoid gaps between countries.</span>
00574    <span class="comment">// Only apply to polygonPARTS, those polygons that are split by breakpoints</span>
00575    <span class="comment">// (whole polygons = not shared between countries)</span>
00576    <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a> firstBreakPoint, lastBreakPoint, onTheWayPoint;
00577    <span class="keywordflow">if</span> ( countryBorder &amp;&amp; breakPoints ) {
00578       <a class="code" href="MC2Logging_8h.html#a2">mc2dbg</a> &lt;&lt; <span class="stringliteral">"Part of country border, size = "</span>
00579              &lt;&lt; tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_7">getNbrCoordinates</a>(0) &lt;&lt; endl;
00580       firstBreakPoint = <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a>(
00581          tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_4">getLat</a>(0,0), tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_5">getLon</a>(0,0) );
00582       lastBreakPoint = <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a>(
00583          tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_4">getLat</a>(0,filtSize-1), tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_5">getLon</a>(0,filtSize-1) );
00584 
00585       <a class="code" href="Types_8h.html#a22">int32</a> lat, lon;
00586       <a class="code" href="Types_8h.html#a19">uint16</a> offset = <a class="code" href="Types_8h.html#a19">uint16</a>( 0.5 * <a class="code" href="Types_8h.html#a2">MAX_UINT16</a> );
00587       tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_18">updateLength</a>();
00588       <span class="keywordflow">if</span> ( tempPolyGfx-&gt;<a class="code" href="classGfxData.html#a11">getCoordinate</a>( offset, lat, lon ) ) {
00589          onTheWayPoint = <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a>( lat, lon );
00590       } <span class="keywordflow">else</span> {
00591          onTheWayPoint = <a class="code" href="classMC2Coordinate.html">MC2Coordinate</a>( 0, 0 );
00592       }
00593       <a class="code" href="MC2Logging_8h.html#a2">mc2dbg</a> &lt;&lt; <span class="stringliteral">"Ident points: first="</span> &lt;&lt; firstBreakPoint &lt;&lt; <span class="stringliteral">" last="</span>
00594              &lt;&lt; lastBreakPoint &lt;&lt; <span class="stringliteral">", onTheWay="</span> &lt;&lt; onTheWayPoint &lt;&lt; endl;
00595       
00596       <span class="keywordtype">bool</span> usedOld = <a class="code" href="classOldMapFilter.html#e1">oldBorderFiltering</a>( 
00597             tempPolyGfx, countryMapName,
00598             firstBreakPoint, lastBreakPoint, onTheWayPoint,
00599             filterForwards, outGfx, p );
00600       
00601       <span class="keywordflow">if</span> ( usedOld ) {
00602          <span class="comment">// Return here, coords were added to outGfx in oldBorderFiltering</span>
00603          <span class="keywordflow">return</span>;
00604       }
00605    }
00606   
00613    <span class="keywordtype">int</span>**  paths= <span class="keyword">new</span> <span class="keywordtype">int</span>*[ filterMaxDists.size() + 1 ];
00614    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; (int)filterMaxDists.size() + 1; ++i ) {
00615       paths[ i ] = <span class="keyword">new</span> <span class="keywordtype">int</span>[ filtSize ];
00616    }
00617    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> l = 0; l &lt; filtSize; l++ ) {
00618       paths[ 0 ][ l ] = l;
00619    }
00620    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 1; i &lt; (int)filterMaxDists.size() + 1; i++ ) {
00621       <span class="keywordflow">for</span>( <span class="keywordtype">int</span> l = 0; l &lt; filtSize; l++ ) {
00622          paths[ i ][ l ] = -1;
00623       }
00624    }
00625 
00626    <span class="comment">/* For all filterlevels up to level 9, filter the polygon part and then </span>
00627 <span class="comment">    * set its lsb's to the values calculated and stored in paths. Backtrack </span>
00628 <span class="comment">    * to find correct values for the lsb's.</span>
00629 <span class="comment">    */</span>
00630 
00631    <span class="comment">// Filter distance = filterMaxDists[ i ] - filterMaxDists[ i-1 ]</span>
00632    <span class="comment">// since we already have filtered filterMaxDists[ i-1 ] meters..</span>
00633    <a class="code" href="Types_8h.html#a21">uint32</a> filterDist;
00634 
00635    <span class="comment">// The level used for all higher level filterings. If you change</span>
00636    <span class="comment">// you must also change in the getFiltHighLevelDistanceForMapGfx</span>
00637    <span class="comment">// method. Note that tweaking of filter distance will be required</span>
00638    <span class="comment">// in order to guarantee that the same number of coordinates on each</span>
00639    <span class="comment">// level will result from the filtering.</span>
00640    <span class="keywordtype">int</span> newStartLevel = 9;
00641 
00642    <span class="keywordtype">int</span> tempPolyGfxSize = filtSize;
00643    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 0; i &lt; newStartLevel; i++ ) {
00644       <span class="comment">// Indata to filter from pre-filter</span>
00645       <a class="code" href="classvector.html">vector&lt;int&gt;</a> rsPath;
00646       <span class="comment">// Outdata from filter</span>
00647       <a class="code" href="classvector.html">vector&lt;int&gt;</a> outIndeces;
00648       <span class="comment">// Outdata from openPolygonFilter</span>
00649       <a class="code" href="classStack.html">Stack</a> coordIdx; 
00650 
00651       <span class="comment">// Filter distance = filterMaxDists[ i ] - filterMaxDists[ i-1 ]</span>
00652       <span class="comment">// since we already have filtered filterMaxDists[ i-1 ] meters..</span>
00653       <a class="code" href="Types_8h.html#a21">uint32</a> filterDist = filterMaxDists[ i ];
00654       <span class="keywordflow">if</span> ( i &gt; 0 ) {
00655          filterDist -= filterMaxDists[ i -1 ];
00656       }
00657       
00658       <span class="comment">// Do the pre-filter filter.</span>
00659       tempPolyGfx-&gt;<a class="code" href="classGfxData.html#a43">openPolygonFilter</a>( 
00660             &amp;coordIdx, i, filterDist,
00661             <a class="code" href="Types_8h.html#a4">MAX_UINT32</a>, <span class="keyword">true</span>,
00662             0,
00663             tempPolyGfxSize - 1 );
00664       
00665       <span class="comment">// Do the filter filter.</span>
00666       <span class="keywordflow">for</span> ( <a class="code" href="Types_8h.html#a21">uint32</a> j = 0; j &lt; coordIdx.<a class="code" href="classStack.html#a6">getStackSize</a>(); ++j ) {
00667          rsPath.push_back( coordIdx.<a class="code" href="classStack.html#a8">getElementAt</a>( j ) );
00668       }
00669       <span class="comment">// Use the non-filtering iterators.</span>
00670       <a class="code" href="classMC2Coordinate.html">GfxData::const_iterator</a> beginIt = tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_0">polyBegin</a>( i );
00671       <a class="code" href="classMC2Coordinate.html">GfxData::const_iterator</a> endIt = tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_1">polyEnd</a>( i );
00672        
00673       <a class="code" href="classGfxFilterUtil.html#e3">GfxFilterUtil::filter</a>( 
00674             outIndeces,
00675             rsPath,
00676             <a class="code" href="classMC2CoordXYHelper.html">MC2CoordXYHelper</a>(),
00677             beginIt, endIt );
00678  
00684       <span class="keywordflow">for</span>( <span class="keywordtype">int</span> l = 0; l &lt; (int)( outIndeces.size() ); l++ ) {
00685          paths[ i + 1 ][ l ] = outIndeces[ l ];  
00686       }
00687       <span class="comment">// Init the tempPolyGfx for the next filterlevel.</span>
00688       tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_25">addPolygon</a>();
00689       <span class="keywordflow">for</span>( <span class="keywordtype">int</span> j = 0; j &lt; (int)outIndeces.size(); j++ ) {
00690          tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_29">addCoordinate</a>(
00691                tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_4">getLat</a>( i, outIndeces[ j ] ),
00692                tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_5">getLon</a>( i, outIndeces[ j ] ) );
00693       }
00694       tempPolyGfxSize = outIndeces.size();
00695    }
00696   
00697    <span class="comment">/* </span>
00698 <span class="comment">    * Next, filter to get levels 15, 14..., 10, using newStartLevel as </span>
00699 <span class="comment">    * starting point. Note that this must be done in reverse </span>
00700 <span class="comment">    * order (15, 14...) since the resulting coordinates from</span>
00701 <span class="comment">    * a level M must be included in M-1.</span>
00702 <span class="comment">    *</span>
00703 <span class="comment">    */</span>
00704  
00705    <span class="comment">// Initializations</span>
00706    <a class="code" href="classOldMapFilter.html">OldMapFilter</a> mapFilter;
00707 
00708    <span class="comment">// We stopped the lower level filtering at level </span>
00709    <span class="comment">// newStartLevel =&gt; tempPolyGfxSize contains newStartLevelSize</span>
00710    <a class="code" href="Types_8h.html#a21">uint32</a> newStartLevelSize = tempPolyGfxSize;
00711 
00712    <a class="code" href="classvector.html">vector&lt;int&gt;</a> splitIndeces;
00713    <a class="code" href="classvector.html">vector&lt;int&gt;</a> splitFilterIdxs; 
00714    <a class="code" href="classvector.html">vector&lt;int&gt;</a> outIndeces;
00715 
00716    <span class="comment">// Note: i represents the level that we are creating, </span>
00717    <span class="comment">// as opposed to the level we are filtering, which is the way it</span>
00718    <span class="comment">// was represented for the lower level filtering above.</span>
00719    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 15; i &gt; newStartLevel; i-- ) {
00720       <span class="comment">// Indata to filter from pre-filter</span>
00721       <a class="code" href="classvector.html">vector&lt;int&gt;</a> rsPath;
00722       <span class="comment">// Outdata from openPolygonFilter</span>
00723       <a class="code" href="classStack.html">Stack</a> coordIdx;
00724 
00725       <span class="keywordflow">if</span>( i == 15) {
00726          <span class="comment">// Determine filter distance for level i+1.</span>
00727          filterDist = mapFilter.<a class="code" href="classOldMapFilter.html#a5">getFiltHighLevelDistanceForMapGfx</a>( i );
00728          
00729          <span class="comment">// Do the pre-filter filter.</span>
00730          tempPolyGfx-&gt;<a class="code" href="classGfxData.html#a43">openPolygonFilter</a>( 
00731                &amp;coordIdx, newStartLevel, filterDist,
00732                <a class="code" href="Types_8h.html#a4">MAX_UINT32</a>, <span class="keyword">true</span>,
00733                0,
00734                newStartLevelSize - 1 );
00735      
00736          <span class="comment">// Do the filter filter.</span>
00737          <span class="keywordflow">for</span> ( <a class="code" href="Types_8h.html#a21">uint32</a> j = 0; j &lt; coordIdx.<a class="code" href="classStack.html#a6">getStackSize</a>(); ++j ) {
00738             rsPath.push_back( coordIdx.<a class="code" href="classStack.html#a8">getElementAt</a>( j ) );
00739          }
00740          <span class="comment">// Use the non-filtering iterators.</span>
00741          <a class="code" href="classMC2Coordinate.html">GfxData::const_iterator</a> beginIt = 
00742             tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_0">polyBegin</a>( newStartLevel );
00743          <a class="code" href="classMC2Coordinate.html">GfxData::const_iterator</a> endIt = 
00744             tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_1">polyEnd</a>( newStartLevel );
00745        
00746          <a class="code" href="classGfxFilterUtil.html#e3">GfxFilterUtil::filter</a>( 
00747                outIndeces,
00748                rsPath,
00749                <a class="code" href="classMC2CoordXYHelper.html">MC2CoordXYHelper</a>(),
00750                beginIt, endIt );
00751 
00757          <span class="keywordflow">for</span>( <span class="keywordtype">int</span> l = 0; l &lt; (int)( outIndeces.size() ); l++ ) { 
00758             paths[ i ][ l ] = outIndeces[ l ];  
00759          }
00760       }
00761       <span class="keywordflow">else</span> {
00762          <span class="comment">// New split indices = indeces of the previous level = outIndeces</span>
00763          splitIndeces.clear();
00764          splitIndeces = outIndeces;
00765          outIndeces.clear();
00766          
00767          <span class="comment">// Determine filter distance for level i.</span>
00768          filterDist = mapFilter.<a class="code" href="classOldMapFilter.html#a5">getFiltHighLevelDistanceForMapGfx</a>( i );
00769 
00770          <span class="comment">// Current pair of split indeces (see below)</span>
00771          <a class="code" href="Types_8h.html#a19">uint16</a> startSplitIdx;
00772          <a class="code" href="Types_8h.html#a19">uint16</a> endSplitIdx;
00773 
00774          <span class="comment">/*</span>
00775 <span class="comment">          * Go through each pair of split indeces, filter </span>
00776 <span class="comment">          * the part 'between them' separately, and then put all</span>
00777 <span class="comment">          * filtered parts together.</span>
00778 <span class="comment">          *</span>
00779 <span class="comment">          */</span>
00780          <span class="keywordflow">for</span>( <span class="keywordtype">int</span> j = 0; j &lt; (int)splitIndeces.size() - 1; j++ ) {
00781             rsPath.clear();
00782             coordIdx.<a class="code" href="classStack.html#a10">reset</a>();
00783             splitFilterIdxs.clear();
00784 
00785             <span class="comment">// Determine current pair of split indeces</span>
00786             startSplitIdx = splitIndeces[ j ];
00787             endSplitIdx = splitIndeces[ j + 1 ];
00788             
00789             <span class="comment">// Create temporary gfx data for split part</span>
00790             <a class="code" href="classGfxDataFull.html">GfxDataFull</a>* tempPolyGfxSplit
00791                 = <a class="code" href="classGMSGfxData.html#e1">GMSGfxData::createNewGfxData</a>( 
00792                    static_cast&lt;OldGenericMap* &gt;( NULL ), <span class="keyword">true</span> );
00793 
00794             <span class="keywordflow">for</span>( <span class="keywordtype">int</span> l = startSplitIdx; l &lt;= endSplitIdx; l++ ) {
00795                tempPolyGfxSplit-&gt;<a class="code" href="classGfxDataFull.html#z499_29">addCoordinate</a>(
00796                   ( tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_4">getLat</a>( newStartLevel, l ) &amp; coordBlankMask ),
00797                   ( tempPolyGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_5">getLon</a>( newStartLevel, l ) &amp; coordBlankMask ),
00798                   false );
00799             }
00800  
00801             <span class="comment">// Do the pre-filter filter.</span>
00802             tempPolyGfxSplit-&gt;<a class="code" href="classGfxData.html#a43">openPolygonFilter</a>(
00803                   &amp;coordIdx, 0 , filterDist,
00804                   <a class="code" href="Types_8h.html#a4">MAX_UINT32</a>, <span class="keyword">true</span>,
00805                   0,
00806                   endSplitIdx - startSplitIdx);
00807 
00808             <span class="comment">// Store result from openPolygon in rsPath</span>
00809             <a class="code" href="MC2Logging_8h.html#a6">mc2dbg8</a> &lt;&lt; <span class="stringliteral">"Result idx from openPolygon: "</span>;
00810             <span class="keywordflow">for</span> ( <a class="code" href="Types_8h.html#a21">uint32</a> j = 0; j &lt; coordIdx.<a class="code" href="classStack.html#a6">getStackSize</a>(); ++j ) {
00811                <a class="code" href="MC2Logging_8h.html#a6">mc2dbg8</a> &lt;&lt; coordIdx.<a class="code" href="classStack.html#a8">getElementAt</a>( j ) + startSplitIdx &lt;&lt; <span class="stringliteral">" "</span>;
00812                rsPath.push_back( coordIdx.<a class="code" href="classStack.html#a8">getElementAt</a>( j ) );
00813             }
00814             <a class="code" href="MC2Logging_8h.html#a6">mc2dbg8</a> &lt;&lt; endl;
00815 
00816             <span class="comment">// Set iterators needed by filter-filter (Kolesnikov)</span>
00817             <a class="code" href="classMC2Coordinate.html">GfxData::const_iterator</a> beginIt =
00818                tempPolyGfxSplit-&gt;<a class="code" href="classGfxDataFull.html#z499_0">polyBegin</a>( 0 );
00819             <a class="code" href="classMC2Coordinate.html">GfxData::const_iterator</a> endIt =
00820                tempPolyGfxSplit-&gt;<a class="code" href="classGfxDataFull.html#z499_1">polyEnd</a>( 0 );
00821 
00822             <span class="comment">// Do the filter filter.            </span>
00823             <a class="code" href="classGfxFilterUtil.html#e3">GfxFilterUtil::filter</a>(
00824                   splitFilterIdxs,
00825                   rsPath,
00826                   <a class="code" href="classMC2CoordXYHelper.html">MC2CoordXYHelper</a>(),
00827                   beginIt, endIt );
00828            
00829             <span class="keyword">delete</span> tempPolyGfxSplit;
00830 
00831             <a class="code" href="MC2Logging_8h.html#a6">mc2dbg8</a> &lt;&lt; <span class="stringliteral">"Result idx from Kolesnikov: "</span>;
00832              
00833             <span class="comment">/* </span>
00834 <span class="comment">             * Map resulting temp indeces to newStartLevel indeces. Also, </span>
00835 <span class="comment">             * avoid adding split points twice. </span>
00836 <span class="comment">             *</span>
00837 <span class="comment">             */</span>
00838             <span class="keywordflow">for</span>( <span class="keywordtype">int</span> l = 0; l &lt; (int)( splitFilterIdxs.size() ); l++ ) {
00839                <span class="keywordflow">if</span>( outIndeces.back() != splitFilterIdxs[ l ] + startSplitIdx) {
00840                   outIndeces.push_back( splitFilterIdxs[ l ] + startSplitIdx );
00841                }
00842                <a class="code" href="MC2Logging_8h.html#a6">mc2dbg8</a> &lt;&lt; splitFilterIdxs[ l ] + startSplitIdx &lt;&lt; <span class="stringliteral">" "</span>;
00843             }
00844             <a class="code" href="MC2Logging_8h.html#a6">mc2dbg8</a> &lt;&lt; endl;
00845 
00846             <a class="code" href="MC2Logging_8h.html#a6">mc2dbg8</a> &lt;&lt; <a class="code" href="MC2Logging_8h.html#a14">info</a> &lt;&lt; <span class="stringliteral">"Kolesnikov ends"</span> &lt;&lt; endl;
00847          } <span class="comment">// end loop of split points</span>
00848          <a class="code" href="MC2Logging_8h.html#a6">mc2dbg8</a> &lt;&lt; <span class="stringliteral">"Ends filtering using split points from previous level "</span>                    &lt;&lt; endl;
00849          
00855          <a class="code" href="MC2Logging_8h.html#a6">mc2dbg8</a> &lt;&lt; <span class="stringliteral">"Indeces: "</span>;
00856          <span class="keywordflow">for</span>( <span class="keywordtype">int</span> l = 0; l &lt; (int)( outIndeces.size() ); l++ ) {
00857             <a class="code" href="MC2Logging_8h.html#a6">mc2dbg8</a> &lt;&lt; outIndeces[ l ] &lt;&lt; <span class="stringliteral">" "</span>;
00858             paths[ i ][ l ] = outIndeces[ l ];
00859          }
00860          <a class="code" href="MC2Logging_8h.html#a6">mc2dbg8</a> &lt;&lt; endl;
00861       } <span class="comment">// End creating level i</span>
00862    } <span class="comment">// End higher level filtering</span>
00863    
00869    <span class="comment">// We have perhaps added some coordinates to outGfx poly p before!</span>
00870    <span class="keyword">const</span> <a class="code" href="Types_8h.html#a21">uint32</a> nbrCoordsAlreadyAdded = outGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_7">getNbrCoordinates</a>(p);
00871    <span class="keywordtype">int</span> startAt = 0;
00872    <span class="keywordflow">if</span> ( nbrCoordsAlreadyAdded &gt; 0 ) {
00873       startAt = 1;
00874    }
00875    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> j = startAt; j &lt; filtSize; j++ ) {
00876       <a class="code" href="Types_8h.html#a21">uint32</a> c = ( (j + opfBegin) % nbrCoordsInGfxPoly );
00877       outGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_29">addCoordinate</a>(
00878             gfx-&gt;<a class="code" href="classGfxData.html#a6">getLat</a>( p, c ) &amp; coordBlankMask,
00879             gfx-&gt;<a class="code" href="classGfxData.html#a7">getLon</a>( p, c ) &amp; coordBlankMask );
00880    }
00881    <span class="keywordflow">if</span> ( dumpFilterInfo ) {
00882       cout &lt;&lt; <span class="stringliteral">" outGfx before="</span> &lt;&lt; nbrCoordsAlreadyAdded &lt;&lt; <span class="stringliteral">" now="</span>
00883            &lt;&lt; outGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_7">getNbrCoordinates</a>(p) &lt;&lt; endl;
00884       <a class="code" href="classOldMapFilter.html#d9">dumpPaths</a>( paths, filterMaxDists.size() + 1, filtSize );
00885    }
00886 
00893    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> i = 1; i &lt; (int)filterMaxDists.size() + 1; i++ ) {
00894       <span class="keywordflow">if</span> ( dumpFilterInfo ) {
00895          cout &lt;&lt; <span class="stringliteral">"level "</span> &lt;&lt; i &lt;&lt; <span class="stringliteral">": "</span>;
00896       }
00897       <span class="keywordtype">int</span> l = 0;
00898       <span class="keywordflow">while</span>( l &lt; filtSize &amp;&amp; ( paths[ i ][ l ] != -1 ) ) {
00899          <span class="keywordtype">int</span> index = paths[ i ][ l ];
00900          <span class="comment">// Lower levels i are filtered using level i-1</span>
00901          <span class="keywordflow">if</span>( i &lt;= newStartLevel) {
00902             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k = i - 1; k &gt; 0; k-- ) {
00903                index = paths[ k ][ index ];
00904             }
00905          } <span class="keywordflow">else</span> { <span class="comment">// Higher levels are filtered using newStartLevel</span>
00906             <span class="keywordflow">for</span>(<span class="keywordtype">int</span> k = newStartLevel; k &gt; 0; k-- ) {
00907                index = paths[ k ][ index ];
00908             }
00909          }
00910          <span class="comment">// pay attention to if filtering was done forwards or backwards</span>
00911          <span class="keywordflow">if</span> ( filterForwards ) {
00912             <span class="comment">// pay attention to if this is not the first part of outGfx</span>
00913             index = (nbrCoordsAlreadyAdded - startAt) + index;
00914          } <span class="keywordflow">else</span> {
00915             <span class="comment">// index counted from the end</span>
00916             index = filtSize - 1 - index;
00917             <span class="comment">// pay attention to if this is not the first part of outGfx</span>
00918             index = (nbrCoordsAlreadyAdded - startAt) + index;
00919          }
00920          outGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_33">setCoordinate</a>( p, index,
00921             ( outGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_4">getLat</a>( p, index ) &amp; coordBlankMask ) + i / setLevelMask,
00922             ( outGfx-&gt;<a class="code" href="classGfxDataFull.html#z499_5">getLon</a>( p, index ) &amp; coordBlankMask ) + i % setLevelMask );
00923          <span class="comment">// if index is 0 and nbrCoordsAlreadyAdded &gt; 0: overwrites the last</span>
00924          <span class="comment">// coord already added to outGfx poly p = ok since they are the one</span>
00925          <span class="comment">// and same break point</span>
00926          <span class="keywordflow">if</span> ( dumpFilterInfo ) {
00927             cout &lt;&lt; index &lt;&lt; <span class="stringliteral">" "</span>;
00928          }
00929          l++;
00930       }
00931       <span class="keywordflow">if</span> ( dumpFilterInfo ) {
00932          cout &lt;&lt; endl;
00933       }
00934    }
00935 
00936    <span class="comment">// Debug printing.</span>
00937    <a class="code" href="config_8h.html#a6">DEBUG4</a>(
00938    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> j = 0; j &lt; filtSize; j++ ) {
00939       <a class="code" href="MC2Logging_8h.html#a5">mc2dbg4</a> &lt;&lt; <span class="stringliteral">"Lat "</span> &lt;&lt; 
00940             (gfx-&gt;<a class="code" href="classGfxData.html#a6">getLat</a>( p, j ) &amp; coordBlankMask) &lt;&lt;
00941             <span class="stringliteral">" Lon "</span> &lt;&lt;
00942             (gfx-&gt;<a class="code" href="classGfxData.html#a7">getLon</a>( p, j ) &amp; coordBlankMask) &lt;&lt; endl;
00943    });
00944    
00945    <span class="comment">// Clean up after ourselfs.</span>
00946    <span class="keywordflow">for</span> ( <span class="keywordtype">int</span> i = 0; i &lt; (int)filterMaxDists.size(); i++ ) {
00947       <span class="keyword">delete</span>[] paths[ i ];
00948    }
00949    <span class="keyword">delete</span>[] paths;
00950 
00951    <span class="comment">// Print our country border part to file (= the part here added to outGfx)</span>
00952    <span class="keywordflow">if</span> ( countryBorder &amp;&amp; breakPoints ) {
00953       ofstream outfile(<span class="stringliteral">"countryBorders.txt"</span>, ios::app);
00954 
00955       <span class="keywordtype">int</span> startAt = 0;
00956       <span class="keywordflow">if</span> (nbrCoordsAlreadyAdded &gt; 0 ) {
00957          startAt = nbrCoordsAlreadyAdded -1;
00958       }
00959       <a class="code" href="MC2Logging_8h.html#a5">mc2dbg4</a> &lt;&lt; <span class="stringliteral">"Part of country border, print to file, "</span> &lt;&lt; filtSize 
00960               &lt;&lt; <span class="stringliteral">" coords, "</span> &lt;&lt; startAt &lt;&lt; <span class="stringliteral">"-&gt;"</span> &lt;&lt; (startAt + filtSize -1) 
00961               &lt;&lt; endl;
00962 
00963       printCountryBorderToFile( 
00964             firstBreakPoint, lastBreakPoint, onTheWayPoint,
00965             countryMapName, outGfx, p, startAt, filtSize );
00966    }
00967 }
00968 
00969 <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00970"></a><a class="code" href="classOldMapFilter.html#d9">00970</a> <a class="code" href="classOldMapFilter.html#d9">OldMapFilter::dumpPaths</a>( <span class="keywordtype">int</span>** paths, <span class="keywordtype">int</span> rows, <span class="keywordtype">int</span> cols )<span class="keyword"> const</span>
00971 <span class="keyword"></span>{
00972    cout &lt;&lt; <span class="stringliteral">" paths = "</span> &lt;&lt; endl;
00973    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> r = 0; r &lt; rows; r++ ) {
00974       <span class="keywordflow">for</span>( <span class="keywordtype">int</span> c = 0; c &lt; cols; c++ ) {
00975          cout &lt;&lt; paths[ r ][ c ] &lt;&lt; <span class="stringliteral">"\t"</span>;
00976       }
00977       cout &lt;&lt; endl;
00978    }
00979 }
00980 
00981 <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l00982"></a><a class="code" href="classOldMapFilter.html#d0">00982</a> <a class="code" href="classOldMapFilter.html#d0">OldMapFilter::initMapGfxDistances</a>()
00983 {
00984    <span class="comment">// filterDist = 1, MAX( (int)(filterDist * 2.5), filterDist + 1 )</span>
00985    <span class="comment">//   1 2 5 12 30 75 187 467 1167 2917 7292 18230 45575 113937 284842</span>
00986    <span class="comment">//</span>
00987    <span class="comment">// filterDist = int( pow(level, 2) * 0.7 * pow(1.6, 0.92 * level) )</span>
00988    <span class="comment">//   1 6 23 63 152 337 707 1424 2777 5284 9853 18069 32678 58400 103308</span>
00989    <span class="comment">//</span>
00990    <span class="comment">// filterDist = int( pow(level, 2) * 0.8 * pow(1.6, 0.89 * level) )</span>
00991    <span class="comment">//   1 7 25 68 161 354 732 1454 2796 5245 9642 17436 31091 54787 95559</span>
00992    
00993    <span class="keywordtype">int</span> filterDist;
00994    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> level = 1; level &lt; 16; level++ ) {
00995       filterDist = int( pow(<span class="keywordtype">double</span>(level), 2) * 0.8 * pow(1.6, 0.89 * level) );
00996       <a class="code" href="classOldMapFilter.html#z242_0">m_mapGfxFilterDistances</a>.push_back( filterDist );
00997    }
00998    <a class="code" href="classOldMapFilter.html#z242_2">m_mapGfxDistDefined</a> = <span class="keyword">true</span>;
00999 }
01000 
01001 <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l01002"></a><a class="code" href="classOldMapFilter.html#d1">01002</a> <a class="code" href="classOldMapFilter.html#d1">OldMapFilter::initMapGfxHighLevelDistances</a>()
01003 {
01004    
01005    <span class="comment">// When computing the higher filtering levels a new filtering</span>
01006    <span class="comment">// algorithm is used. These distances are tweaked so that the</span>
01007    <span class="comment">// resulting number of coordinates is as close as possible as </span>
01008    <span class="comment">// the number of coordinates resulting from the original </span>
01009    <span class="comment">// algorithm.</span>
01010    <span class="keywordtype">int</span> filterDist;
01011    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> level = 1; level &lt; 16; level++ ) {
01012       filterDist = int( pow(<span class="keywordtype">double</span>(level), 2) * 0.8 * pow(1.6, 0.76 * level) );
01013       <span class="keywordflow">if</span>( level == 15 ) {
01014          <a class="code" href="classOldMapFilter.html#z242_1">m_mapGfxFilterHighLevelDistances</a>.push_back( 36200 );
01015       } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( level == 14) {
01016          <a class="code" href="classOldMapFilter.html#z242_1">m_mapGfxFilterHighLevelDistances</a>.push_back( 22000 );
01017       } <span class="keywordflow">else</span> <span class="keywordflow">if</span>( level == 10) {
01018          <a class="code" href="classOldMapFilter.html#z242_1">m_mapGfxFilterHighLevelDistances</a>.push_back( 2600 );
01019       } <span class="keywordflow">else</span> {
01020          <a class="code" href="classOldMapFilter.html#z242_1">m_mapGfxFilterHighLevelDistances</a>.push_back( filterDist );
01021       }
01022    }
01023 }
01024 
01025 <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l01026"></a><a class="code" href="classOldMapFilter.html#d2">01026</a> <a class="code" href="classOldMapFilter.html#d2">OldMapFilter::initAreaItemDistances</a>( <span class="keywordtype">int</span> minAreaFilterDistance )
01027 {
01028    <span class="comment">// filterDist = 1, MAX( (int)(filterDist * 2.5), filterDist + 1 )</span>
01029    <span class="comment">//                 MAX( filterDist, minAreaFilterDistance * level )</span>
01030    <span class="comment">//                 minAreaFilterDistance = 3</span>
01031    <span class="comment">//   3 6 9 12 30 75 187 467 1167 2917 7292 18230 45575 113937 284842</span>
01032    <span class="comment">//</span>
01033    <span class="comment">// filterDist = int( pow(level, 2) * 0.8 * pow(1.6, 0.89 * level) )</span>
01034    <span class="comment">//   1 7 25 68 161 354 732 1454 2796 5245 9642 17436 31091 54787 95559</span>
01035    
01036    <span class="keywordtype">int</span> filterDist;
01037    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> level = 1; level &lt; 16; level++ ) {
01038       filterDist = int( pow(<span class="keywordtype">double</span>(level), 2) * 0.8 * pow(1.6, 0.89 * level) );
01039       <span class="keywordflow">if</span> ( minAreaFilterDistance &gt; -1 ) {
01040          filterDist = <a class="code" href="Utility_8h.html#a2">MAX</a>( filterDist, minAreaFilterDistance*level );
01041       }
01042       <a class="code" href="classOldMapFilter.html#z242_4">m_areaItemFilterDistances</a>.push_back( filterDist );
01043    }
01044    <a class="code" href="classOldMapFilter.html#z242_5">m_areaItemDistDefined</a> = <span class="keyword">true</span>;
01045 }
01046 
01047 <span class="keyword">inline</span> <span class="keywordtype">void</span>
<a name="l01048"></a><a class="code" href="classOldMapFilter.html#d3">01048</a> <a class="code" href="classOldMapFilter.html#d3">OldMapFilter::initLineItemDistances</a>( <span class="keywordtype">int</span> minLineFilterDistance )
01049 {
01050    <span class="comment">// filterDist = 1, MAX( (int)(filterDist * 2.0), filterDist + 1 )</span>
01051    <span class="comment">//                 MAX( filterDist, minLineFilterDistance * level )</span>
01052    <span class="comment">//                 minLineFilterDistance 1 meter, co-map: 50 meters</span>
01053    <span class="comment">//   1 2 4 8 16 32 64 128 256 512 1024 2048 4096 8192 16384</span>
01054    <span class="comment">//   50 100 150 200 250 300 350 400 450 512 1024 2048 4096 8192 16384</span>
01055    <span class="comment">//</span>
01056    <span class="comment">// filterDist = int( pow(level, 2) * 0.8 * pow(1.6, 0.89 * level) )</span>
01057    <span class="comment">//   1 7 25 68 161 354 732 1454 2796 5245 9642 17436 31091 54787 95559</span>
01058    
01059    <span class="keywordtype">int</span> filterDist;
01060    <span class="keywordflow">for</span>( <span class="keywordtype">int</span> level = 1; level &lt; 16; level++ ) {
01061       filterDist = int( pow(<span class="keywordtype">double</span>(level), 2) * 0.8 * pow(1.6, 0.89 * level) );
01062       <span class="keywordflow">if</span> ( minLineFilterDistance &gt; -1 ) {
01063          filterDist = <a class="code" href="Utility_8h.html#a2">MAX</a>( filterDist, minLineFilterDistance*level );
01064       }
01065       <a class="code" href="classOldMapFilter.html#z242_6">m_lineItemFilterDistances</a>.push_back( filterDist );
01066    }
01067    <a class="code" href="classOldMapFilter.html#z242_7">m_lineItemDistDefined</a> = <span class="keyword">true</span>;
01068 }
01069 
01070 <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l01071"></a><a class="code" href="classOldMapFilter.html#a4">01071</a> <a class="code" href="classOldMapFilter.html#a4">OldMapFilter::getFiltDistanceForMapGfx</a>( uint32 level )
01072 {
01073    <span class="keywordflow">if</span> ( level &gt; 15 ) {
01074       <span class="comment">// invalid level</span>
01075       <span class="keywordflow">return</span> 0;
01076    }
01077 
01078    <span class="comment">// make sure that the vector with map gfx data distances</span>
01079    <span class="comment">// m_mapGfxFilterDistances is initialised</span>
01080    <span class="keywordflow">if</span> ( ! m_mapGfxDistDefined ) {
01081       <a class="code" href="classOldMapFilter.html#d0">initMapGfxDistances</a>();
01082    }
01083 
01084    <span class="comment">// filt level 0 is no filtering,</span>
01085    <span class="keywordflow">if</span> ( level &lt;= 0 ) {
01086       <span class="keywordflow">return</span> 0;
01087    }
01088  
01089    <span class="comment">// filt level 1 is first filtering, i.e. index 0 in the vector</span>
01090    <a class="code" href="Types_8h.html#a21">uint32</a> vectorIdx = level - 1;
01091    <span class="keywordflow">return</span> ( <a class="code" href="classOldMapFilter.html#z242_0">m_mapGfxFilterDistances</a>[ vectorIdx ] );
01092 }
01093 
01094 <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l01095"></a><a class="code" href="classOldMapFilter.html#a5">01095</a> <a class="code" href="classOldMapFilter.html#a5">OldMapFilter::getFiltHighLevelDistanceForMapGfx</a>( uint32 level )
01096 {
01097    <span class="keywordflow">if</span> ( level &gt; 15 ) {
01098       <span class="comment">// invalid level</span>
01099       <span class="keywordflow">return</span> 0;
01100    }
01101 
01102    <span class="comment">// make sure that the vector with map gfx data distances</span>
01103    <span class="comment">// m_mapGfxFilterDistances is initialised</span>
01104    <span class="keywordflow">if</span> ( ! m_mapGfxHighLevelDistDefined ) {
01105       <a class="code" href="classOldMapFilter.html#d1">initMapGfxHighLevelDistances</a>();
01106    }
01107 
01108    <span class="comment">// filt level 0 is no filtering,</span>
01109    <span class="keywordflow">if</span> ( level &lt;= 0 ) {
01110       <span class="keywordflow">return</span> 0;
01111    }
01112 
01113    <span class="comment">// filt level 1 is first filtering, i.e. index 0 in the vector</span>
01114    <a class="code" href="Types_8h.html#a21">uint32</a> vectorIdx = level - 1;
01115    <span class="keywordflow">return</span> ( <a class="code" href="classOldMapFilter.html#z242_1">m_mapGfxFilterHighLevelDistances</a>.at(vectorIdx) );
01116 }
01117 
01118 
01119 <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l01120"></a><a class="code" href="classOldMapFilter.html#a6">01120</a> <a class="code" href="classOldMapFilter.html#a6">OldMapFilter::getFiltDistanceForAreaItem</a>(
01121                uint32 level, <span class="keywordtype">int</span> minAreaFilterDistance )
01122 {
01123    <span class="keywordflow">if</span> ( level &gt; 15 ) {
01124       <span class="comment">// invalid level</span>
01125       <span class="keywordflow">return</span> 0;
01126    }
01127 
01128    <span class="comment">// make sure that the vector with area item distances</span>
01129    <span class="comment">// m_areaItemFilterDistances is initialised</span>
01130    <span class="keywordflow">if</span> ( ! m_areaItemDistDefined ) {
01131       <a class="code" href="classOldMapFilter.html#d2">initAreaItemDistances</a>( minAreaFilterDistance );
01132    }
01133 
01134    <span class="comment">// filt level 0 is no filtering,</span>
01135    <span class="keywordflow">if</span> ( level &lt;= 0 ) {
01136       <span class="keywordflow">return</span> 0;
01137    }
01138    
01139    <span class="comment">// filt level 1 is first filtering, i.e. index 0 in the vector</span>
01140    <a class="code" href="Types_8h.html#a21">uint32</a> vectorIdx = level - 1;
01141    <span class="keywordflow">return</span> ( <a class="code" href="classOldMapFilter.html#z242_4">m_areaItemFilterDistances</a>[ vectorIdx ] );
01142 }
01143 
01144 <span class="keyword">inline</span> <span class="keywordtype">int</span>
<a name="l01145"></a><a class="code" href="classOldMapFilter.html#a7">01145</a> <a class="code" href="classOldMapFilter.html#a7">OldMapFilter::getFiltDistanceForLineItem</a>(
01146                uint32 level, <span class="keywordtype">int</span> minLineFilterDistance )
01147 {
01148    <span class="keywordflow">if</span> ( level &gt; 15 ) {
01149       <span class="comment">// invalid level</span>
01150       <span class="keywordflow">return</span> 0;
01151    }
01152 
01153    <span class="comment">// make sure that the vector with line item distances</span>
01154    <span class="comment">// m_lineItemFilterDistances is initialised</span>
01155    <span class="keywordflow">if</span> ( ! m_lineItemDistDefined ) {
01156       <a class="code" href="classOldMapFilter.html#d3">initLineItemDistances</a>( minLineFilterDistance );
01157    }
01158 
01159    <span class="comment">// filt level 0 is no filtering,</span>
01160    <span class="keywordflow">if</span> ( level &lt;= 0 ) {
01161       <span class="keywordflow">return</span> 0;
01162    }
01163    
01164    <span class="comment">// filt level 1 is first filtering, i.e. index 0 in the vector</span>
01165    <a class="code" href="Types_8h.html#a21">uint32</a> vectorIdx = level - 1;
01166    <span class="keywordflow">return</span> ( <a class="code" href="classOldMapFilter.html#z242_6">m_lineItemFilterDistances</a>[ vectorIdx ] );
01167 }
01168 
01169 <span class="preprocessor">#endif</span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Wed Jun 30 10:11:48 2010 for mc2 by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.3.9.1 </small></address>
</body>
</html>
